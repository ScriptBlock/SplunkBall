'
'            -/ooooo+/:o:::-..`                                                                                                     
'       `shh+:--...` -dsoo+:.``.o:                                                                                                 
'     `` -+//:.` oy+//+/::--/+//shy-                                                                                               
'   `-.`:o/.-..`.:/:---.`..---.:/--ho`                                                                                             
'  `/.:s/-/-`:s/:--...`--.`:+...`.:.+y.                                                                                            
' `o.oh./+`. .:/oyhddddNmhs:-++`:yyyshho+.   `yhhhhhs/.    yh/ ohhhhhhhh.    `yhy`      `hh:      :hhhhhhyo:`  /hy`  ohh/      `hh+
' s--s-o/`:`-osdNms/:::+yNNmo--ooMy:::/odNs  `NMy/+ohMm-  `mMs ://hMMo//`    yMNMs`     `NM+      +MM+//+smMh` oMm.  hMMMs`    .NMs
'-y ` /s`+```sMN+`       .sMNo.`sMs     .dM: `NM+   .MMo  `mMs    sMN.      +MN/mM+     `NM+      +MM.    -MM+ oMm.  hMdyMd-   .NMs
'oo -.h/.+ ::MM+          `hMm-`oMs     :mN- `NMh+oodMm.  `mMs    sMN.     :MM/ +MN:    `NM+      +MM-...:yMN- oMm.  hMh`oNN+  .NMs
'so`/ . -+ +/MM-           sMNh.oMs/ooyhmh:  `NMmhhhdNmo` `mMs    sMN.    .mMd:-:mMm.   `NM+      +MMmddmmmy-  oMm.  hMh  :mMy..NMs
'oy o .`.h`o.mMh`         -mMds oMs+oNN/.    `NM+    :MM+ `mMs    sMN.   `dMNmmmmmNMd`  `NM+      +MM:--..`    oMm.  hMh   .yMd/NMs
'+N//:`:`/.`s/dMd/.`   `-omMho.:yMs`:odmo`   `NMo```.+MM+ `mMs    sMN.  `yMN-`````:NMy  `NM+````` +MM.         oMm.  hMh    `+NNMMs
'.o:`s:-/``..-./hmmdhhdmmmy+:./+oNo`o.hhNh-  `NMNddmmNd+  `mMs    sMN.  +MM/       /MM+ `NMNddddd:+MM.         oMm.  hMh      :dMMs
'  .`.s/.+:.--..-:/osyss+.`.:/-+:.-/.sy....   -:::::-.`    -:.    .:-   -:-         -:-  -::::::-``-:          .:-   .:-       `::.
'   --`+s:/o/--::/::/:``..---/o+.---yo`                                 `/ooo+.  :ooo+:  +:  `o.  :o++/ `:ooo+-.+oo/.o`o-   //-o+++
'    .:::ys .+ss``.-:-``-:/+/+. `.os-                                  -d+.``//.hs.``-hy ms  -N:  oy..`.hs.``-+.`mo`-N`/m. /m-+m...
'      ./+:```.-`````.---:/osy/-+o.                                    +d      :N-    /M ms  -N:  omoo/:m-       mo -N` sh:m: +Nooo
'        `-+oo/:--::///+/--.::/-                                       `yh/:/y+`+d+::od/ mh::-No::oh::-`oh+::ss` mo -N`  hN+  +N:::
'             -/ossyMs ``...                                             `-::.   `-::-   ----`----.---.  `-::.   -. `-   `-   .----
'                                              ....`    `...`   `....`....``....`   ....`   `.  `.    ``    .....
'Orbital Framework 0.1                              
'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  Credits
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
' Compiled and built by Scottywic
' Code snippets by JP Salas, Flupper, DJRobX, NailBuster, ninuzzu, HauntFreaks rothbauerw & many more.
' I'll attempt to make ammends for anyone left out.
' For details using this framework check https://www.youtube.com/channel/UC_vroB2Uboi8GytbQSIepPQ


	Option Explicit
	Randomize


'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  FRAMEWORK Options
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  

	Const typefont = "Raleway Medium"
	Const numberfont = "Bebas Neue"
	Const zoomfont = "Fundamental  Brigade"
	Const zoombgfont = "Fundamental 3D  Brigade" ' needs to be an outline of the zoomfont
	Const cGameName = "SplunkBall"
	Const TableName = "SplunkBall"
	Const myVersion = "1.0.0"
	


'********************************************************************************************************************************************
'********************************************************************************************************************************************
'********************************************************************************************************************************************
'********************************************************************************************************************************************
'********************************************************************************************************************************************
'FRAMEWORK BASE CODE STARTS HERE
'********************************************************************************************************************************************
'********************************************************************************************************************************************
'********************************************************************************************************************************************
'********************************************************************************************************************************************
'********************************************************************************************************************************************

'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  VARIABLES
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
' 	

	'Constructions
	Const BallSize = 50
	Const MaxPlayers = 4
	' TODO NZ: Implement Ballsaver time 
	Const BallSaverTime = 15 
	Const MaxMultiplier = 6 
	Const MaxMultiballs = 5
	'TODO NZ: I assume this is BallsPerGame?  refactor to match style
	Const bpgcurrent = 3
	Const BumperBonusCount = 20

	Const LowerPlayfieldObjective = 0
	Const UpperPlayfieldObjective = 1
	Const OrbitPlayfieldObjective = 2
	Const TargetsPlayfieldObjective = 3

	Const TargetObjectiveA = 0
	Const TargetObjectiveB = 1
	Const TargetObjectiveC = 2
	Const TargetObjectiveD = 3
	Const TargetObjectiveE = 4

	
	' Define Global Variables

	' TODO NZ: remove turnon/off and replace with state
	Dim TopperVideo
	'Dim BallRollerOn
	Dim TurnOnUltraDMD
	Dim TurnOffRules

	Dim PlayersPlayingGame
	Dim CurrentPlayer
	Dim Credits
	Dim BonusPoints(4)
	Dim BonusHeldPoints(4)
	Dim BonusMultiplier(4)
	Dim bBonusHeld
	Dim BallsRemaining(4)
	Dim ExtraBallsAwards(4)
	Dim Score(4)
	Dim HighScore(4)
	Dim HighScoreName(4)
	Dim JackpotActive
	Dim Tilt
	Dim TiltSensitivity
	Dim Tilted
	Dim TotalGamesPlayed
	Dim mBalls2Eject
	Dim SkillshotValue(4)
	Dim bAutoPlunger
	Dim bInstantInfo
	Dim bromconfig
	Dim bAttractMode
	Dim LastSwitchHit
	Dim BallsOnPlayfield
	Dim BallsInHole
	Dim bFreePlay
	Dim bGameInPlay
	Dim bOnTheFirstBall
	Dim bBallInPlungerLane
	Dim bBallSaverActive
	Dim bBallSaverReady
	Dim bMultiBallMode
	Dim bMusicOn
	Dim bSkillshotReady
	Dim bExtraBallWonThisBall
	Dim bJustStarted
	Dim BumperHitCount
	Dim StreamOrbitCount
	Dim Invincibility
	Dim RightOutlaneSaverMode
	Dim LeftOutlaneSaverMode
	Dim PowerupRampMode
	Dim PlayfieldObjectives(4)
	Dim TargetObjectives(5)
	Dim UpperPlayfieldDTsHit
	Dim LowerPlayfieldDTsHit
	Dim LeftLockballMode
	Dim RightLockballMode
	Dim RightLockballArmed
	Dim LeftLockballArmed
	
	
	Dim LoggingQueue
	Dim LogBufferCounter
	Dim ObjFSO
	Dim LogFile

	
'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  Player Options
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  

	TurnOffRules = 0 ' change to 1 to take off the backglass helper rules text during a game
	TurnOnUltraDMD = 0 ' change to 1 to turn on ultradmd
	TopperVideo = 0 'set to 1 to turn on the topper
	'BallRollerOn = 0 ' set to 0 to turn off the ball roller if you use the "c" key in your cabinet
	
	
	BeginLogging
	Sub BeginLogging
		Set ObjFSO = CreateObject("Scripting.FileSystemObject")
		Set LogFile = objFSO.OpenTextFile("splunkball.log",8, true)
		Set LoggingQueue = New Queue
		LogBufferCounter = 0
	End Sub
	
	Sub WriteLog(words) 
		LoggingQueue.Enqueue(Now & ": " & words)
	End Sub

	Sub LoggingTimer_Timer
		If loggingQueue.Count > 0 Then
			'Set LogFile = objFSO.OpenTextFile("splunkball.log",8, true)
			LogFile.WriteLine(LoggingQueue.Dequeue)
			LogBufferCounter = LogBufferCounter + 1
			If LogBufferCounter = 1 Then
				LogBufferCounter = 0
				LogFile.Close()
				Set LogFile = objFSO.OpenTextFile("splunkball.log",8, true)
			End If
			'LogFile.Close()
			
		End If
	End Sub

	
	LoadCoreFiles
	Sub LoadCoreFiles
		WriteLog("Loading Core Files")
		On Error Resume Next
		ExecuteGlobal GetTextFile("core.vbs")
		If Err Then MsgBox "Can't open core.vbs"
		On Error Goto 0
	End Sub

	Dim EnableBallControl
	EnableBallControl = false 'Change to true to enable manual ball control (or press C in-game) via the arrow keys and B (boost movement) keys


'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  Controller VBS stuff, but with b2s not started
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'***Controller.vbs version 1.2***'
'

Const directory = "HKEY_CURRENT_USER\SOFTWARE\Visual Pinball\Controller\"
Dim objShell
Dim PopupMessage
Dim B2SController
Dim Controller
Const DOFContactors = 1
Const DOFKnocker = 2
Const DOFChimes = 3
Const DOFBell = 4
Const DOFGear = 5
Const DOFShaker = 6
Const DOFFlippers = 7
Const DOFTargets = 8
Const DOFDropTargets = 9
Const DOFOff = 0
Const DOFOn = 1
Const DOFPulse = 2

Dim DOFeffects(9)
Dim B2SOn
Dim B2SOnALT

Sub LoadEM
	LoadController("EM")
End Sub

Sub LoadPROC(VPMver, VBSfile, VBSver)
	LoadVBSFiles VPMver, VBSfile, VBSver
	LoadController("PROC")
End Sub

Sub LoadVPM(VPMver, VBSfile, VBSver)
	LoadVBSFiles VPMver, VBSfile, VBSver
	LoadController("VPM")
End Sub

Sub LoadVPMALT(VPMver, VBSfile, VBSver)
	LoadVBSFiles VPMver, VBSfile, VBSver
	LoadController("VPMALT")
End Sub

Sub LoadVBSFiles(VPMver, VBSfile, VBSver)
	On Error Resume Next
	If ScriptEngineMajorVersion < 5 Then MsgBox "VB Script Engine 5.0 or higher required"
	ExecuteGlobal GetTextFile(VBSfile)
	If Err Then MsgBox "Unable to open " & VBSfile & ". Ensure that it is in the same folder as this table. " & vbNewLine & Err.Description	
	InitializeOptions
End Sub

Sub LoadVPinMAME
	Set Controller = CreateObject("VPinMAME.Controller")
	If Err Then MsgBox "Can't load VPinMAME." & vbNewLine & Err.Description
	If VPMver > "" Then If Controller.Version < VPMver Or Err Then MsgBox "VPinMAME ver " & VPMver & " required."
	If VPinMAMEDriverVer < VBSver Or Err Then MsgBox VBSFile & " ver " & VBSver & " or higher required."
	On Error Goto 0
End Sub

Sub LoadController(TableType)
	WriteLog("Loading Controller")
	Dim FileObj
	Dim DOFConfig
	Dim TextStr2
	Dim tempC
	Dim count
	Dim ISDOF
	Dim Answer
	
	B2SOn = False
	B2SOnALT = False
	tempC = 0
	on error resume next
	Set objShell = CreateObject("WScript.Shell")
	objShell.RegRead(directory & "ForceDisableB2S")
	If Err.number <> 0 Then
		PopupMessage = "This latest version of Controller.vbs stores its settings in the registry. To adjust the values, you must use VP 10.2 (or newer) and setup your configuration in the DOF section of the -Keys, Nudge and DOF- dialog of Visual Pinball."
		objShell.RegWrite directory & "ForceDisableB2S",0, "REG_DWORD"
		objShell.RegWrite directory & "DOFContactors",2, "REG_DWORD"
		objShell.RegWrite directory & "DOFKnocker",2, "REG_DWORD"
		objShell.RegWrite directory & "DOFChimes",2, "REG_DWORD"
		objShell.RegWrite directory & "DOFBell",2, "REG_DWORD"
		objShell.RegWrite directory & "DOFGear",2, "REG_DWORD"
		objShell.RegWrite directory & "DOFShaker",2, "REG_DWORD"
		objShell.RegWrite directory & "DOFFlippers",2, "REG_DWORD"
		objShell.RegWrite directory & "DOFTargets",2, "REG_DWORD"
		objShell.RegWrite directory & "DOFDropTargets",2, "REG_DWORD"
		MsgBox PopupMessage
	End If
	tempC = objShell.RegRead(directory & "ForceDisableB2S")
	DOFeffects(1)=objShell.RegRead(directory & "DOFContactors")
	DOFeffects(2)=objShell.RegRead(directory & "DOFKnocker")
	DOFeffects(3)=objShell.RegRead(directory & "DOFChimes")
	DOFeffects(4)=objShell.RegRead(directory & "DOFBell")
	DOFeffects(5)=objShell.RegRead(directory & "DOFGear")
	DOFeffects(6)=objShell.RegRead(directory & "DOFShaker")
	DOFeffects(7)=objShell.RegRead(directory & "DOFFlippers")
	DOFeffects(8)=objShell.RegRead(directory & "DOFTargets")
	DOFeffects(9)=objShell.RegRead(directory & "DOFDropTargets")
	Set objShell = nothing

	If TableType = "PROC" or TableType = "VPMALT" Then
		If TableType = "PROC" Then
			WriteLog("TableType=VPROC")
			Set Controller = CreateObject("VPROC.Controller")
			If Err Then MsgBox "Can't load PROC"
		Else
			LoadVPinMAME
		End If		
		If tempC = 0 Then
			On Error Resume Next
			If Controller is Nothing Then
				Err.Clear
			Else
				WriteLog("TableType=B2S")
				Set B2SController = CreateObject("B2S.Server")
				If B2SController is Nothing Then
					Err.Clear
				Else
					B2SController.B2SName = B2ScGameName
					B2SController.Run()
					On Error Goto 0
					B2SOn = True
					B2SOnALT = True
				End If
			End If
		End If
	Else
		If tempC = 0 Then
			On Error Resume Next
			Set Controller = CreateObject("B2S.Server")
			If Controller is Nothing Then
				Err.Clear
				If TableType = "VPM" Then 
					WriteLog("TableType=VPM")
					LoadVPinMAME
				End If
			Else
				Controller.B2SName = cGameName
				If TableType = "EM" Then
					WriteLog("TableType=EM")
					Controller.Run()
				End If
				On Error Goto 0
				B2SOn = True
			End If
		Else
			If TableType = "VPM" Then 
				WriteLog("TableType=VPM")
				LoadVPinMAME
			End If
		End If
		Set DOFConfig=Nothing
		Set FileObj=Nothing
	End If
End sub

Function SoundFX (Sound, Effect)
	If ((Effect = 0 And B2SOn) Or DOFeffects(Effect)=1) Then
		SoundFX = ""
	Else
		SoundFX = Sound
	End If
End Function

Function SoundFXDOF (Sound, DOFevent, State, Effect)
	WriteLog("Function=SoundFXDOF DOFEvent=" & DOFEvent & " State=" &  State & " Effect=" & Effect)
	If DOFeffects(Effect)=1 Then
		SoundFXDOF = ""
		DOF DOFevent, State
	ElseIf DOFeffects(Effect)=2 Then
		SoundFXDOF = Sound
		DOF DOFevent, State
	Else
		SoundFXDOF = Sound
	End If
End Function

Function SoundFXDOFALT (Sound, DOFevent, State, Effect)
	If DOFeffects(Effect)=1 Then
		SoundFXDOFALT = ""
		DOFALT DOFevent, State
	ElseIf DOFeffects(Effect)=2 Then
		SoundFXDOFALT = Sound
		DOFALT DOFevent, State
	Else
		SoundFXDOFALT = Sound
	End If
End Function


Sub DOF(DOFevent, State)
	WriteLog("Function=DOF DOFEvent=" & DOFEvent & " State=" &  State)
	If B2SOn Then
		If State = 2 Then
			Controller.B2SSetData DOFevent, 1
			Controller.B2SSetData DOFevent, 0
		Else
			Controller.B2SSetData DOFevent, State
		End If
	End If
End Sub

Sub DOFALT(DOFevent, State)
	If B2SOnALT Then
		If State = 2 Then
			B2SController.B2SSetData DOFevent, 1
			B2SController.B2SSetData DOFevent, 0
		Else
			B2SController.B2SSetData DOFevent, State
		End If
	End If
End Sub




'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'   TABLE INITS & MATHS
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  

	'UMLD
	Sub Table1_Init()
		WriteLog("Table1_Init Called")
		Randomize

		ResetBackGlass
		DMD_Init
		LoadEM
		LoadHighScore
		
		bAttractMode = False
		bOnTheFirstBall = False
		bBallInPlungerLane = False
		bBallSaverActive = False
		bBallSaverReady = False
		bMultiBallMode = False
		bGameInPlay = False
		bAutoPlunger = False
		bMusicOn = True
		BallsOnPlayfield = 0
		BallsInHole = 0
		
		LastSwitchHit = ""
		Tilt = 0
		TiltSensitivity = 6
		Tilted = False
		bBonusHeld = False
		bJustStarted = True
		
		
		GiOff
		PuPlayer.SendMSG "{ ""mt"":301, ""SN"": 2, ""FN"":4, ""FS"":1 }"
		'StartAttractMode
	End Sub


	'********************
	' MATHS
	'********************

	Function RndNum(min,max)
	 RndNum = Int(Rnd()*(max-min+1))+min     ' Sets a random number between min AND max
	End Function


'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'   KEYS
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  

	'TODO NZ: Make this whole thing into a big switch/case
	Sub Table1_KeyDown(ByVal KeyCode)
		WriteLog("Action=KeyDown Key=" & KeyCode)

		'This is for manual ball control
'		If BallRollerOn = 1 then
'			If KeyCode = 46 then ' C Key
'				 If ManualBallControlActive = 1 Then
'						WriteLog("Manual ball control deactivated")
'					  ManualBallControlActive = 0
'				 Else
'						WriteLog("Manual ball control activated")
'					  ManualBallControlActive = 1
'				 End If
'			End If
'		End If
'		
'		'More ball control shenanigans
'		If KeyCode = 48 Then 'B Key
'			 If bcboost = 1 Then
'				  bcboost = bcboostmulti
'			 Else
'				  bcboost = 1
'			 End If
'		End If
		
		'Ball control 
		If KeyCode = 203 Then bcleft = 1 ' Left Arrow
		If KeyCode = 200 Then bcup = 1 ' Up Arrow
		If KeyCode = 208 Then bcdown = 1 ' Down Arrow
		If KeyCode = 205 Then bcright = 1 ' Right Arrow


		If KeyCode = PlungerKey Then
			PlaySoundAt "fx_plungerpull", Plunger
			Plunger.Pullback
		End If

		If hsbModeActive = True Then
			'only for high score mode
			EnterHighScoreKey(KeyCode)
		ElseIf bGameInPlay Then
		
			If KeyCode = LeftTiltKey Then Nudge 90, 6:PlaySound SoundFX("fx_nudge",0), 0, 1, -0.1, 0.25:CheckTilt
			If KeyCode = RightTiltKey Then Nudge 270, 6:PlaySound SoundFX("fx_nudge",0), 0, 1, 0.1, 0.25:CheckTilt
			If KeyCode = CenterTiltKey Then Nudge 0, 7:PlaySound SoundFX("fx_nudge",0), 0, 1, 1, 0.25:CheckTilt
			
			If NOT Tilted Then
				If KeyCode = LeftFlipperKey Then
					WriteLog("Action=LeftFlipper")
					FL_LowerLeft.RotateToEnd
					FL_UpperLeft.RotateToEnd
					PlaySound SoundFX("fx_flipperup",DOFFlippers), 0, .67, AudioPan(FL_LowerLeft), 0.05,0,0,1,AudioFade(FL_LowerLeft)
					'TODO NZ: used for cinematic skipping.  not implemented
					'ldown = 1
					'checkdown
					'TODO NZ: implement skill shot and fix this?
					If bSkillshotReady = False Then
						RotateLaneLightsLeft
					End If
				End If
				
				If KeyCode = RightFlipperKey Then 
					WriteLog("Action=RightFlipper")
					FL_LowerRight.RotateToEnd
					FL_UpperRight.RotateToEnd
					FL_UpperTop.RotateToEnd
					PlaySound SoundFX("fx_flipperup",DOFFlippers), 0, .67, AudioPan(FL_LowerRight), 0.05,0,0,1,AudioFade(FL_LowerRight)
					'TODO NZ: used for cinematic skipping.  not implemented
					'rdown = 1
					'checkdown
					'TODO NZ: implement skill shot and fix this?
					If bSkillshotReady = False Then
						RotateLaneLightsRight
					End If
				End If

				If KeyCode = StartGameKey Then
					WriteLog("Action=StartGame Note='GameInPlay Is True'")
					If((PlayersPlayingGame <MaxPlayers) AND(bOnTheFirstBall = True) ) Then
						PlayersPlayingGame = PlayersPlayingGame + 1
						If PlayersPlayingGame = 1 Then
							PuPlayer.playlistplayex pCallouts,"audiocallouts","player1.wav",80,1
							ChillOutTheMusic
						End If

						If PlayersPlayingGame = 2 Then
							PuPlayer.LabelSet pBackglass,"Play2","PLAYER 2",1,"{'mt':2}"
							pUpdateScores
							PuPlayer.playlistplayex pCallouts,"audiocallouts","player2.wav",80,1
							ChillOutTheMusic
						End If

						If PlayersPlayingGame = 3 Then
							PuPlayer.LabelSet pBackglass,"Play3","PLAYER 3",1,"{'mt':2}"
							pUpdateScores
							PuPlayer.playlistplayex pCallouts,"audiocallouts","player3.wav",80,1
							ChillOutTheMusic
						End If

						If PlayersPlayingGame = 4 Then
							PuPlayer.LabelSet pBackglass,"Play4","PLAYER 4",1,"{'mt':2}"
							pUpdateScores	
							PuPlayer.playlistplayex pCallouts,"audiocallouts","player4.wav",80,1
							ChillOutTheMusic
						End If

						TotalGamesPlayed = TotalGamesPlayed + 1
						SaveGamesPlayed
					End If ' first ball and < max players
				End If ' start game key
			End If ' not tilted
		Else ' not high score mode, and not game being played
			If NOT Tilted Then

				If KeyCode = LeftFlipperKey OR KeyCode = RightFlipperKey Then 
					WriteLog("Action=DMDIntroFlippers")
					DMDIntroLoop
					IntroTime = 0
				End If

				If KeyCode = StartGameKey Then
					WriteLog("Action=StartGame Note='bGameInPlay is false'")
					If(BallsOnPlayfield = 0) Then
						WriteLog("Action=StartGame Note='BallsOnPlayField=0 Should be calling resetfornewgame'")
						ResetForNewGame()
					End If
				End If
			End If 
		End If
	End Sub


	Sub Table1_KeyUp(ByVal KeyCode)
		'Manual Ball Control
		If KeyCode = 203 then bcleft = 0 ' Left Arrow
		If KeyCode = 200 then bcup = 0 ' Up Arrow
		If KeyCode = 208 then bcdown = 0 ' Down Arrow
		If KeyCode = 205 then bcright = 0 ' Right Arrow

		If KeyCode = PlungerKey Then
			PlaySoundAt "fx_plunger", Plunger
			Plunger.Fire
		End If

		' Table specific
		If Not Tilted Then
			If bGameInPlay and hsbModeActive <> True Then
				If KeyCode = LeftFlipperKey Then
					'ldown = 0
					FL_LowerLeft.RotateToStart
					FL_UpperLeft.RotateToStart

					PlaySound SoundFX("fx_flipperdown",DOFFlippers), 0, 1, AudioPan(FL_LowerLeft), 0.05,0,0,1,AudioFade(FL_LowerLeft)
				End If
				If KeyCode = RightFlipperKey Then
					FL_LowerRight.RotateToStart
					FL_UpperRight.RotateToStart
					FL_UpperTop.RotateToStart
					PlaySound SoundFX("fx_flipperdown",DOFFlippers), 0, 1, AudioPan(FL_LowerRight), 0.05,0,0,1,AudioFade(FL_LowerRight)
				End If
			End If
		End If
	End Sub



'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  MANUAL BALLCONTROL
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
	' 

'	Sub StartControl_Hit()
'		 Set ControlBall = ActiveBall
'		 ManualBallControlInPlay = true
'	End Sub
'
'	Sub StopControl_Hit()
'		 ManualBallControlInPlay = false
'	End Sub
'	
'	Sub TR_BallLaunch_Hit() 
'		 Set ControlBall = ActiveBall
'		 ManualBallControlInPlay = true
'	End Sub
'
'	Dim bcup, bcdown, bcleft, bcright, ManualBallControlActive, ManualBallControlInPlay, ControlBall, bcboost
'	Dim bcvel, bcyveloffset, bcboostmulti
'
'	bcboost = 1 'Do Not Change - default setting
'	bcvel = 4 'Controls the speed of the ball movement
'	bcyveloffset = -0.01 'Offsets the force of gravity to keep the ball from drifting vertically on the table, should be negative
'	bcboostmulti = 3 'Boost multiplier to ball veloctiy (toggled with the B key)
'
'	Sub BallControl_Timer()
'		 If ManualBallControlActive and ManualBallControlInPlay then
'			  If bcright = 1 Then
'				   ControlBall.velx = bcvel*bcboost
'			  ElseIf bcleft = 1 Then
'				   ControlBall.velx = - bcvel*bcboost
'			  Else
'				   ControlBall.velx=0
'			  End If
'
'			 If bcup = 1 Then
'				  ControlBall.vely = -bcvel*bcboost
'			 ElseIf bcdown = 1 Then
'				  ControlBall.vely = bcvel*bcboost
'			 Else
'				  ControlBall.vely= bcyveloffset
'			 End If
'		 End If
'	End Sub






'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'   SHADOWS
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  


	'*****************************************
	'	ninuzzu's	FLIPPER SHADOWS
	'*****************************************
	'TODO NZ: implement this.  this should not be invoked because this timer isn't on the table yet
	sub FlipperTimer_Timer()
		FlipperLSh.RotZ = LeftFlipper.currentangle
		FlipperRSh.RotZ = RightFlipper.currentangle
	End Sub

	'*****************************************
	'	ninuzzu's	BALL SHADOW
	'*****************************************
	Dim BallShadow
	BallShadow = Array (BallShadow1,BallShadow2,BallShadow3,BallShadow4,BallShadow5)

	Sub BallShadowUpdate_timer()
		Dim BOT, b
		BOT = GetBalls
		' hide shadow of deleted balls
		If UBound(BOT)<(tnob-1) Then
			For b = (UBound(BOT) + 1) to (tnob-1)
				BallShadow(b).visible = 0
			Next
		End If
		' exit the Sub if no balls on the table
		If UBound(BOT) = -1 Then Exit Sub
		' render the shadow for each ball
		For b = 0 to UBound(BOT)
			If BOT(b).X < Table1.Width/2 Then
				BallShadow(b).X = ((BOT(b).X) - (Ballsize/6) + ((BOT(b).X - (Table1.Width/2))/7)) + 6
			Else
				BallShadow(b).X = ((BOT(b).X) + (Ballsize/6) + ((BOT(b).X - (Table1.Width/2))/7)) - 6
			End If
			ballShadow(b).Y = BOT(b).Y + 12
			If BOT(b).Z > 20 Then
				BallShadow(b).visible = 1
			Else
				BallShadow(b).visible = 0
			End If
		Next
	End Sub


'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  qqq
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'   TILT
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  


	'NOTE: The TiltDecreaseTimer Subtracts .01 from the "Tilt" variable every round

	Sub CheckTilt                                    'Called when table is nudged
		Tilt = Tilt + TiltSensitivity                'Add to tilt count
		TiltDecreaseTimer.Enabled = True
		If(Tilt> TiltSensitivity) AND(Tilt <15) Then 'show a warning
			pNote "CAREFUL!","TILT WARNING"
			'PlaySound "buzz"
			PuPlayer.playlistplayex pBackglass,"videotilt","",100,1
			DOF 131, DOFPulse
			DOF 311, DOFPulse  'DOF MX - Tilt Warning
		End if
		If Tilt> 15 Then 'If more that 15 then TILT the table
			Tilted = True
			pNote "TILT",""
			'PlaySound "powerdownn"
			PuPlayer.playlistplayex pBackglass,"videotilt","",100,4
			DOF 310, DOFPulse   'DOF MX - TILT
			DOF 127, DOFOff   'DOF - Beacon - OFF
			DisableTable True
			TiltRecoveryTimer.Enabled = True 'start the Tilt delay to check for all the balls to be drained
		End If
	End Sub


	Sub TiltDecreaseTimer_Timer
		' DecreaseTilt
		If Tilt> 0 Then
			Tilt = Tilt - 0.1
		Else
			TiltDecreaseTimer.Enabled = False
		End If
	End Sub

	Sub DisableTable(Enabled)
		If Enabled Then
			GiOff
			LS_Tilt.Play SeqAllOff

			FL_LowerLeft.RotateToStart
			FL_UpperLeft.RotateToStart
			FL_LowerRight.RotateToStart
			FL_UpperRight.RotateToStart
			FL_UpperTop.RotateToStart


			W_LeftSS.Disabled = 1
			W_RightSS.Disabled = 1
			PuPlayer.playresume 4
			PuPlayer.playlistplayex pAudio,"audiomodes","clear.mp3",100,1
			PuPlayer.playlistplayex pMusic,"audioclear","clear.mp3",100, 1
		Else
			'GiOn
			LS_Tilt.StopPlay
			W_LeftSS.Disabled = 0
			W_RightSS.Disabled = 0
		End If
	End Sub

	Sub TiltRecoveryTimer_Timer()
		If(BallsOnPlayfield = 0) Then
			EndOfBall()
			TiltRecoveryTimer.Enabled = False
		End If
	End Sub



'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'   SOUND FUNCTIONS
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  


	'*********************************************************************
	'                 Positional Sound Playback Functions
	'*********************************************************************

	' Play a sound, depending on the X,Y position of the table element (especially cool for surround speaker setups, otherwise stereo panning only)
	' parameters (defaults): loopcount (1), volume (1), randompitch (0), pitch (0), useexisting (0), restart (1))
	' Note that this will not work (currently) for walls/slingshots as these do not feature a simple, single X,Y position
	Sub PlayXYSound(soundname, tableobj, loopcount, volume, randompitch, pitch, useexisting, restart)
		PlaySound soundname, loopcount, volume, AudioPan(tableobj), randompitch, pitch, useexisting, restart, AudioFade(tableobj)
	End Sub

	' Similar subroutines that are less complicated to use (e.g. simply use standard parameters for the PlaySound call)
	Sub PlaySoundAt(soundname, tableobj)
		PlaySound soundname, 1, 1, AudioPan(tableobj), 0,0,0, 1, AudioFade(tableobj)
	End Sub

	Sub PlaySoundAtBall(soundname)
		PlaySoundAt soundname, ActiveBall
	End Sub


	'*********************************************************************
	'                     Supporting Ball & Sound Functions
	'*********************************************************************

	Function AudioFade(tableobj) ' Fades between front and back of the table (for surround systems or 2x2 speakers, etc), depending on the Y position on the table. "table1" is the name of the table
		Dim tmp
		tmp = tableobj.y * 2 / table1.height-1
		If tmp > 0 Then
			AudioFade = Csng(tmp ^10)
		Else
			AudioFade = Csng(-((- tmp) ^10) )
		End If
	End Function

	Function AudioPan(tableobj) ' Calculates the pan for a tableobj based on the X position on the table. "table1" is the name of the table
		Dim tmp
		tmp = tableobj.x * 2 / table1.width-1
		If tmp > 0 Then
			AudioPan = Csng(tmp ^10)
		Else
			AudioPan = Csng(-((- tmp) ^10) )
		End If
	End Function

	Function Vol(ball) ' Calculates the Volume of the sound based on the ball speed
		Vol = Csng(BallVel(ball) ^2 / 2000)
	End Function

	Function Pitch(ball) ' Calculates the pitch of the sound based on the ball speed
		Pitch = BallVel(ball) * 20
	End Function

	Function BallVel(ball) 'Calculates the ball speed
		BallVel = INT(SQR((ball.VelX ^2) + (ball.VelY ^2) ) )
	End Function


	'*****************************************
	'      JP's VP10 Rolling Sounds
	'*****************************************
	'TODO NZ: this is probably wrong if multiball is > 5
	Const tnob = 5 ' total number of balls
	ReDim rolling(tnob)
	InitRolling

	Sub InitRolling
		Dim i
		For i = 0 to tnob
			rolling(i) = False
		Next
	End Sub

	Sub RollingTimer_Timer()
		Dim BOT, b
		BOT = GetBalls

		' stop the sound of deleted balls
		For b = UBound(BOT) + 1 to tnob
			rolling(b) = False
			StopSound("fx_ballrolling" & b)
		Next

		' exit the sub if no balls on the table
		If UBound(BOT) = -1 Then Exit Sub

		' play the rolling sound for each ball
		For b = 0 to UBound(BOT)
			If BallVel(BOT(b) ) > 1 AND BOT(b).z < 30 Then
				rolling(b) = True
				PlaySound("fx_ballrolling" & b), -1, Vol(BOT(b)), AudioPan(BOT(b)), 0, Pitch(BOT(b)), 1, 0, AudioFade(BOT(b))
			Else
				If rolling(b) = True Then
					StopSound("fx_ballrolling" & b)
					rolling(b) = False
				End If
			End If
		Next
	End Sub

	'**********************
	' Ball Collision Sound
	'**********************

	Sub OnBallBallCollision(ball1, ball2, velocity)
		PlaySound("fx_collide"), 0, Csng(velocity) ^2 / 2000, AudioPan(ball1), 0, Pitch(ball1), 0, 0, AudioFade(ball1)
	End Sub

	'**************************************
	' Explanation of the collision routine
	'**************************************

	' The collision is built in VP.
	' You only need to add a Sub OnBallBallCollision(ball1, ball2, velocity) and when two balls collide they 
	' will call this routine. What you add in the sub is up to you. As an example is a simple Playsound with volume and paning
	' depending of the speed of the collision.


	'Sub Pins_Hit (idx)
	'	PlaySound "pinhit_low", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 0, 0, AudioFade(ActiveBall)
	'End Sub

	Sub Targets_Hit (idx)
		PlaySound "target", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 0, 0, AudioFade(ActiveBall)
		'WriteLog("A Target was hit - " & idx)
		'WriteLog("TargetName = " & Targets(idx).Name)
	End Sub

	Sub Metals_Thin_Hit (idx)
		PlaySound "metalhit_thin", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
	End Sub

	Sub Metals_Medium_Hit (idx)
		PlaySound "metalhit_medium", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
	End Sub

	Sub Metals2_Hit (idx)
		PlaySound "metalhit2", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
	End Sub

	Sub Gates_Hit (idx)
		PlaySound "gate4", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
	End Sub

	Sub SP_PowerupRamp_Spin
		PlaySound "fx_spinner", 0, .25, AudioPan(SP_PowerupRamp), 0.25, 0, 0, 1, AudioFade(SP_PowerupRamp)
	End Sub

	Sub Rubbers_Hit(idx)
		dim finalspeed
		finalspeed=SQR(activeball.velx * activeball.velx + activeball.vely * activeball.vely)
		If finalspeed > 20 then 
			PlaySound "fx_rubber2", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
		End if
		If finalspeed >= 6 AND finalspeed <= 20 then
			RandomSoundRubber()
		End If
	End Sub

	Sub Posts_Hit(idx)
		dim finalspeed
		finalspeed=SQR(activeball.velx * activeball.velx + activeball.vely * activeball.vely)
		If finalspeed > 16 then 
			PlaySound "fx_rubber2", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
		End if
		If finalspeed >= 6 AND finalspeed <= 16 then
			RandomSoundRubber()
		End If
	End Sub

	Sub RandomSoundRubber()
		Select Case Int(Rnd*3)+1
			Case 1 : PlaySound "rubber_hit_1", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
			Case 2 : PlaySound "rubber_hit_2", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
			Case 3 : PlaySound "rubber_hit_3", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
		End Select
	End Sub

'	Sub LeftFlipper_Collide(parm)
'		RandomSoundFlipper()
'	End Sub
'
'	Sub RightFlipper_Collide(parm)
'		RandomSoundFlipper()
'	End Sub

	Sub LeftFlippers_Collide(parm)
		RandomSoundFlipper()
	End Sub

	Sub RightFlippers_Collide(parm)
		RandomSoundFlipper()
	End Sub

	
	Sub RandomSoundFlipper()
		Select Case Int(Rnd*3)+1
			Case 1 : PlaySound "flip_hit_1", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
			Case 2 : PlaySound "flip_hit_2", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
			Case 3 : PlaySound "flip_hit_3", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
		End Select
	End Sub




'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'   START GAME, END GANE
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  

'
	Sub ResetForNewGame()
		WriteLog("Function=ResetForNewGame")
		Dim i
		bGameInPLay = True
		'StopAttractMode
		'GiOn
		'GiOff
		TotalGamesPlayed = TotalGamesPlayed + 1
		SaveGamesPlayed
		CurrentPlayer = 1
		PlayersPlayingGame = 1
		bOnTheFirstBall = True
		For i = 1 To MaxPlayers
			Score(i) = 0
			BonusPoints(i) = 0
			BonusHeldPoints(i) = 0
			BonusMultiplier(i) = 1
			BallsRemaining(i) = 3
			ExtraBallsAwards(i) = 0
		Next
		Tilt = 0
		Game_Init()
		WriteLog("Function=ResetForNewGame Calling=VPMTimer.AddTimer Note='For FirstBall'")
		vpmTimer.addtimer 1500, "FirstBall() '"

	End Sub


	Sub EndOfGame()
		PuPlayer.playlistplayex pMusic,"audioclear","clear.mp3",100, 1
		pNote "GAME OVER","PLAY AGAIN"
		PuPlayer.playlistplayex pBackglass,"videogameover","",100,1
		'StartAttractMode
		IntroPosition = 0
		bGameInPlay = False
		bJustStarted = False
		GiOff
	End Sub



'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'   ULTRADMD SCRIPTING
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  

	Dim UltraDMD

	' DMD using UltraDMD calls

	Sub DMD(background, toptext, bottomtext, duration)
		If TurnOnUltraDMD = 0 Then exit sub
		UltraDMD.DisplayScene00 background, toptext, 15, bottomtext, 15, 14, duration, 14
		UltraDMDTimer.Enabled = 1 'to show the score after the animation/message
	End Sub

	Sub DMDScore
		If TurnOnUltraDMD = 0 then exit sub
		UltraDMD.SetScoreboardBackgroundImage "scoreboard-background.jpg", 15, 7
		UltraDMD.DisplayScoreboard PlayersPlayingGame, CurrentPlayer, Score(1), Score(2), Score(3), Score(4), "Player " & CurrentPlayer, "Ball " & Balls
	End Sub

	Sub DMDScoreNow
		If TurnOnUltraDMD = 0 then exit sub
		DMDFlush
		DMDScore
	End Sub

	Sub DMDFLush
		If TurnOnUltraDMD = 0 then exit sub
		UltraDMDTimer.Enabled = 0
		UltraDMD.CancelRendering
	End Sub

	Sub DMDScrollCredits(background, text, duration)
		If TurnOnUltraDMD = 0 then exit sub
		UltraDMD.ScrollingCredits background, text, 15, 14, duration, 14
	End Sub

	Sub DMDId(id, background, toptext, bottomtext, duration)
		If TurnOnUltraDMD = 0 then exit sub
		UltraDMD.DisplayScene00ExwithID id, False, background, toptext, 15, 0, bottomtext, 15, 0, 14, duration, 14
	End Sub

	Sub DMDMod(id, toptext, bottomtext, duration)
		If TurnOnUltraDMD = 0 then exit sub
		UltraDMD.ModifyScene00Ex id, toptext, bottomtext, duration
	End Sub

	Sub UltraDMDTimer_Timer 'used for the attrackmode and the instant info.
		If TurnOnUltraDMD = 0 then exit sub
		If bInstantInfo Then
			InstantInfo
		ElseIf bAttractMode Then 'nadda
		ElseIf NOT UltraDMD.IsRendering Then
			DMDScoreNow
		ElseIf bromconfig Then
			romconfig
		End If
	End Sub

	Sub DMD_Init
		WriteLog("Function=DMD_Init")
		If TurnOnUltraDMD = 0 then exit sub
		Set UltraDMD = CreateObject("UltraDMD.DMDObject")
		If UltraDMD is Nothing Then
			MsgBox "No UltraDMD found.  This table will NOT run without it."
			Exit Sub
		End If
		WriteLog("Function=DMD_Init Note='Found UltraDMD object'")
		UltraDMD.Init
		If TurnOnUltraDMD = 0 then exit sub
		If Not UltraDMD.GetMajorVersion = 1 Then
			MsgBox "Incompatible Version of UltraDMD found."
			Exit Sub
		End If
		WriteLog("Function=DMD_Init Note='UltraDMD Initialized'")
		If UltraDMD.GetMinorVersion <1 Then
		If TurnOnUltraDMD = 0 then exit sub
			MsgBox "Incompatible Version of UltraDMD found. Please update to version 1.1 or newer."
			Exit Sub
		End If

		Dim fso:Set fso = CreateObject("Scripting.FileSystemObject")
		Dim curDir:curDir = fso.GetAbsolutePathName(".")

		Dim DirName
		DirName = curDir& "\" &TableName& ".UltraDMD"

		If Not fso.FolderExists(DirName) Then _
				Msgbox "UltraDMD userfiles directory '" & DirName & "' does not exist." & CHR(13) & "No graphic images will be displayed on the DMD"
		UltraDMD.SetProjectFolder DirName

		' wait for the animation to end
		While UltraDMD.IsRendering = True
		WEnd
		WriteLog("Function=DMD_Init Note='UltraDMD Render Complete'")

	End Sub




'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'   Pinup Active Backglass
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  

'**************************
'   PinUp Player Config
'   Change HasPuP = True if using PinUp Player Videos
'**************************

	Dim HasPup:HasPuP = True

	Dim PuPlayer

	Const pTopper=0
	Const pDMD=1
	Const pBackglass=2
	Const pPlayfield=3
	Const pMusic=4
	Const pAudio=7
	Const pCallouts=8

	if HasPuP Then
		on error resume next
		Set PuPlayer = CreateObject("PinUpPlayer.PinDisplay") 
		on error goto 0
		if not IsObject(PuPlayer) then HasPuP = False
	end If

	if HasPuP Then
		WriteLog("Initializing PUP because hasPUP = true")
		PuPlayer.Init pBackglass,cGameName
		PuPlayer.Init pMusic,cGameName
		PuPlayer.Init pAudio,cGameName
		PuPlayer.Init pCallouts,cGameName
		If TopperVideo = 1 Then 
			PuPlayer.Init pTopper,cGameName
		End If

		PuPlayer.SetScreenex pBackglass,0,0,0,0,0       'Set PuPlayer DMD TO Always ON    <screen number> , xpos, ypos, width, height, POPUP
		PuPlayer.SetScreenex pAudio,0,0,0,0,2
		PuPlayer.hide pAudio
		PuPlayer.SetScreenex pMusic,0,0,0,0,2
		PuPlayer.hide pMusic
		PuPlayer.SetScreenex pCallouts,0,0,0,0,2
		PuPlayer.hide pCallouts


		PuPlayer.playlistadd pMusic,"audioattract", 1 , 0
		PuPlayer.playlistadd pAudio,"audioevents", 1 , 0
		PuPlayer.playlistadd pCallouts,"audiocallouts", 1 , 0
		PuPlayer.playlistadd pBackglass,"backglass", 1 , 0
		PuPlayer.playlistadd pBackglass,"PuPOverlays", 1 , 0
		PuPlayer.playlistadd pBackglass,"videoattract", 1 , 0


		If TopperVideo = 1 Then 
			PuPlayer.playlistadd pTopper,"topper", 1 , 0
		End If

	'Set Background video on DMD
		PuPlayer.playlistplayex pBackglass,"backglass","backglass.jpg",0,1
		'PuPlayer.playlistplayex pBackglass,"PuPOverlays","overlay.png",0,1
		PuPlayer.SetBackground pBackglass,1	

	End if

	If TopperVideo = 1 Then
		PuPlayer.playlistplayex pTopper,"topper","topper.mp4",0,1
		PuPlayer.SetBackground pTopper,1	
	End If


	PuPlayer.LabelInit pBackglass

	'Setup Pages.  Note if you use fonts they must be in FONTS folder of the pupVideos\tablename\FONTS
	'syntax - PuPlayer.LabelNew <screen# or pDMD>,<Labelname>,<fontName>,<size%>,<colour>,<rotation>,<xAlign>,<yAlign>,<xpos>,<ypos>,<PageNum>,<visible>

	'Page 1 (default score display)
	PuPlayer.LabelNew pBackglass,"Play1",typefont,			3,16777215  ,0,0,1,23,81,1,0
	PuPlayer.LabelNew pBackglass,"Play1score",numberfont,	3,16777215  ,0,0,1,31,81,1,0
	PuPlayer.LabelNew pBackglass,"Play2",typefont,			3,16777215  ,0,0,1,23,85,1,0
	PuPlayer.LabelNew pBackglass,"Play2score",numberfont,	3,16777215  ,0,0,1,31,85,1,0
	PuPlayer.LabelNew pBackglass,"Play3",typefont,			3,16777215  ,0,0,1,23,89,1,0
	PuPlayer.LabelNew pBackglass,"Play3score",numberfont,	3,16777215  ,0,0,1,31,89,1,0
	PuPlayer.LabelNew pBackglass,"Play4",typefont,			3,16777215  ,0,0,1,23,93,1,0
	PuPlayer.LabelNew pBackglass,"Play4score",numberfont,	3,16777215  ,0,0,1,31,93,1,0
	PuPlayer.LabelNew pBackglass,"curscore",numberfont,		7,16777215	,0,1,1,50,87,1,1
	PuPlayer.LabelNew pBackglass,"Ball",typefont,			2,16777215 	,0,1,1,50,81,1,1
	PuPlayer.LabelNew pBackglass,"curplayer",typefont,		3,0		 	,0,1,1,50,93,1,1
	PuPlayer.LabelNew pBackglass,"hstitle",typefont,		3,444665 	,0,1,1,65,89,1,1
	PuPlayer.LabelNew pBackglass,"hs",numberfont,			3,16777215 	,0,1,1,65,93,1,1
	PuPlayer.LabelNew pBackglass,"gptitle",typefont,		3,8421504 	,0,1,1,77,89,1,1
	PuPlayer.LabelNew pBackglass,"gp",numberfont,			3,16777215 	,0,1,1,77,93,1,1
	PuPlayer.LabelNew pBackglass,"notetitle",numberfont,	3,16777215  ,0,1,1,50,12,1,1
	PuPlayer.LabelNew pBackglass,"notecopy",typefont,		2,16777215 	,0,1,1,50,15,1,1
	PuPlayer.LabelNew pBackglass,"titlebg",zoombgfont,		9,0  		,0,1,1,50,50,1,1
	PuPlayer.LabelNew pBackglass,"title",zoomfont,			9,16777215 	,0,1,1,50,50,1,1
	PuPlayer.LabelNew pBackglass,"titlebg2",zoombgfont,		6,0  		,0,1,1,50,50,1,1
	PuPlayer.LabelNew pBackglass,"title2",zoomfont,			6,16777215 	,0,1,1,50,50,1,1
	PuPlayer.LabelNew pBackglass,"lefttitle",numberfont,	3,0			,0,1,1,11,82,1,1
	PuPlayer.LabelNew pBackglass,"lefttimer",numberfont,	8,16777215  ,0,1,1,11,87,1,1
	PuPlayer.LabelNew pBackglass,"leftdetail",typefont,		2,0	  		,0,1,1,11,93,1,1
	PuPlayer.LabelNew pBackglass,"righttitle",numberfont,	3,0			,0,1,1,89,82,1,1
	PuPlayer.LabelNew pBackglass,"righttimer",numberfont,	8,16777215  ,0,1,1,89,87,1,1
	PuPlayer.LabelNew pBackglass,"rightdetail",typefont,	2,0	  		,0,1,1,89,93,1,1
	PuPlayer.LabelNew pBackglass,"high1name",typefont,		5,16777215  ,0,1,1,22,30,1,1
	PuPlayer.LabelNew pBackglass,"high1score",numberfont,	5,16777215  ,0,1,1,36,30,1,1
	PuPlayer.LabelNew pBackglass,"high2name",typefont,		5,16777215  ,0,1,1,22,38,1,1
	PuPlayer.LabelNew pBackglass,"high2score",numberfont,	5,16777215  ,0,1,1,36,38,1,1
	PuPlayer.LabelNew pBackglass,"high3name",typefont,		5,16777215  ,0,1,1,22,46,1,1
	PuPlayer.LabelNew pBackglass,"high3score",numberfont,	5,16777215  ,0,1,1,36,46,1,1
	PuPlayer.LabelNew pBackglass,"high4name",typefont,		5,16777215  ,0,1,1,22,54,1,1
	PuPlayer.LabelNew pBackglass,"high4score",numberfont,	5,16777215  ,0,1,1,36,54,1,1
	PuPlayer.LabelNew pBackglass,"HighScore",typefont,		6,16777215	,0,0,1,20,30,1,1
	PuPlayer.LabelNew pBackglass,"HighScoreL1",numberfont,	8,16777215	,0,0,1,20,40,1,1
	PuPlayer.LabelNew pBackglass,"HighScoreL2",numberfont,	8,16777215	,0,0,1,24,40,1,1
	PuPlayer.LabelNew pBackglass,"HighScoreL3",numberfont,	8,16777215	,0,0,1,28,40,1,1
	PuPlayer.LabelNew pBackglass,"HighScoreL4",numberfont,	4,16777215	,0,0,1,20,50,1,1

	
	Sub ChillOutTheMusic
		PuPlayer.SendMSG "{ ""mt"":301, ""SN"": 2, ""FN"":11, ""VL"":10 }"
		PuPlayer.SendMSG "{ ""mt"":301, ""SN"": 4, ""FN"":11, ""VL"":10 }"
		PuPlayer.SendMSG "{ ""mt"":301, ""SN"": 7, ""FN"":11, ""VL"":10 }"
		vpmtimer.addtimer 2200, "turnitbackup'"
	End Sub

	Sub turnitbackup
		PuPlayer.SendMSG "{ ""mt"":301, ""SN"": 2, ""FN"":11, ""VL"":99 }"
		PuPlayer.SendMSG "{ ""mt"":301, ""SN"": 4, ""FN"":11, ""VL"":99 }"
		PuPlayer.SendMSG "{ ""mt"":301, ""SN"": 7, ""FN"":11, ""VL"":99 }"
	End Sub



	'UMLD
	Sub ResetBackGlass
		WriteLog("Function=ResetBackGlass")
		LoadHighScore
		PuPlayer.LabelShowPage pBackglass,1,0,""
		PuPlayer.playlistplayex pBackglass,"scene","layout.png",0,1
		PuPlayer.SetBackground pBackglass,1
		PuPlayer.LabelSet pBackglass,"hstitle","HIGH SCORE",1,""
		PuPlayer.LabelSet pBackglass,"hs","" & FormatNumber(HighScore(0),0),1,""
		PuPlayer.LabelSet pBackglass,"gptitle","GAMES",1,""
		PuPlayer.LabelSet pBackglass,"gp","" & FormatNumber(TotalGamesPlayed,0),1,""
		PuPlayer.LabelSet pBackglass,"Ball","PRESS\rSTART",1,""

		PuPlayer.LabelSet pBackglass,"lefttitle","DATA ITEM",1,""
		PuPlayer.LabelSet pBackglass,"lefttimer","455",1,""
		PuPlayer.LabelSet pBackglass,"leftdetail","PRESS\rSTART",1,""
		PuPlayer.LabelSet pBackglass,"righttitle","DATA ITEM",1,""
		PuPlayer.LabelSet pBackglass,"righttimer","455",1,""
		PuPlayer.LabelSet pBackglass,"rightdetail","PRESS\rSTART",1,""
	End Sub


	Dim titlepos
	titlepos = 0
	titletimer.enabled = 0
	dim title
	title = ""
	dim subtitle
	subtitle = ""

	Sub TitleTimer_Timer
		titlepos = titlepos + 1
		Select Case titlepos
			Case 1
				PuPlayer.LabelSet pBackglass,"title",title,1,"{'mt':2,'color':2565927, 'size': 0, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg",title,1,"{'mt':2,'color':0, 'size': 0, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"title2",subtitle,1,"{'mt':2,'color':2565927, 'size': 0, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg2",subtitle,1,"{'mt':2,'color':0, 'size': 0, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
			Case 2
				PuPlayer.LabelSet pBackglass,"title",title,1,"{'mt':2,'color':5066061, 'size': 0.6, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg",title,1,"{'mt':2,'color':0, 'size': 0.6, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"title2",subtitle,1,"{'mt':2,'color':5066061, 'size': 0.4, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg2",subtitle,1,"{'mt':2,'color':0, 'size': 0.4, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
			Case 3
				PuPlayer.LabelSet pBackglass,"title",title,1,"{'mt':2,'color':7960953, 'size': 1.2, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg",title,1,"{'mt':2,'color':0, 'size': 1.2, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"title2",subtitle,1,"{'mt':2,'color':7960953, 'size': 0.8, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg2",subtitle,1,"{'mt':2,'color':0, 'size': 0.8, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
			Case 4
				PuPlayer.LabelSet pBackglass,"title",title,1,"{'mt':2,'color':9671571, 'size': 1.8, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg",title,1,"{'mt':2,'color':0, 'size': 1.8, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"title2",subtitle,1,"{'mt':2,'color':9671571, 'size': 1.2, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg2",subtitle,1,"{'mt':2,'color':0, 'size': 1.2, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
			Case 5
				PuPlayer.LabelSet pBackglass,"title",title,1,"{'mt':2,'color':11842740, 'size': 2.4, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg",title,1,"{'mt':2,'color':0, 'size': 2.4, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"title2",subtitle,1,"{'mt':2,'color':11842740, 'size': 1.6, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg2",subtitle,1,"{'mt':2,'color':0, 'size': 1.6, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
			Case 6
				PuPlayer.LabelSet pBackglass,"title",title,1,"{'mt':2,'color':13224393, 'size': 3, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg",title,1,"{'mt':2,'color':0, 'size': 3, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"title2",subtitle,1,"{'mt':2,'color':13224393, 'size': 2, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg2",subtitle,1,"{'mt':2,'color':0, 'size': 2, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
			Case 7
				PuPlayer.LabelSet pBackglass,"title",title,1,"{'mt':2,'color':14671839, 'size': 3.6, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg",title,1,"{'mt':2,'color':0, 'size': 3.6, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"title2",subtitle,1,"{'mt':2,'color':14671839, 'size': 2.4, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg2",subtitle,1,"{'mt':2,'color':0, 'size': 2.4, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
			Case 8
				PuPlayer.LabelSet pBackglass,"title",title,1,"{'mt':2,'color':15790320, 'size': 4.2, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg",title,1,"{'mt':2,'color':0, 'size': 4.2, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"title2",subtitle,1,"{'mt':2,'color':15790320, 'size': 2.8, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg2",subtitle,1,"{'mt':2,'color':0, 'size': 2.8, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
			Case 9
				PuPlayer.LabelSet pBackglass,"title",title,1,"{'mt':2,'color':16316664, 'size': 4.8, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg",title,1,"{'mt':2,'color':0, 'size': 4.8, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"title2",subtitle,1,"{'mt':2,'color':16316664, 'size': 3.2, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg2",subtitle,1,"{'mt':2,'color':0, 'size': 3.2, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
			Case 10
				PuPlayer.LabelSet pBackglass,"title",title,1,"{'mt':2,'color':16777215, 'size': 5.4, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg",title,1,"{'mt':2,'color':0, 'size': 5.4, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"title2",subtitle,1,"{'mt':2,'color':16777215, 'size': 3.6, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg2",subtitle,1,"{'mt':2,'color':0, 'size': 3.6, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
			Case 11
				PuPlayer.LabelSet pBackglass,"title",title,1,"{'mt':2,'color':16777215, 'size': 6, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg",title,1,"{'mt':2,'color':0, 'size': 6, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"title2",subtitle,1,"{'mt':2,'color':16777215, 'size': 4, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg2",subtitle,1,"{'mt':2,'color':0, 'size': 4, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
			Case 150
				PuPlayer.LabelSet pBackglass,"title","",1,"{'mt':2,'color':16777215, 'size': 6, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg","",1,"{'mt':2,'color':0, 'size': 6, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"title2","",1,"{'mt':2,'color':16777215, 'size': 4, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
				PuPlayer.LabelSet pBackglass,"titlebg2","",1,"{'mt':2,'color':0, 'size': 4, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
				titlepos = 0
				titletimer.enabled = 0
		End Select
	End Sub

	
	Sub pNote(msgText,msg2text)
		WriteLog("Function=pNote msgText='" & msgText & "' msg2text='" & msg2text & "'")
		title = msgText
		subtitle = msg2text
		If titlepos = 0 Then
			titletimer.enabled = 1
		Else
			titlepos = 0
			titletimer.enabled = 1
			PuPlayer.LabelSet pBackglass,"title","",1,"{'mt':2,'color':16777215, 'size': 6, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
			PuPlayer.LabelSet pBackglass,"titlebg","",1,"{'mt':2,'color':0, 'size': 6, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
			PuPlayer.LabelSet pBackglass,"title2","",1,"{'mt':2,'color':16777215, 'size': 4, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
			PuPlayer.LabelSet pBackglass,"titlebg2","",1,"{'mt':2,'color':0, 'size': 4, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
		End If
	End Sub




	'Sub currentplayerbackglass
	'End Sub


	Sub pUpdateScores
		WriteLog("Function=pUpdateScores")
		PuPlayer.LabelSet pBackglass,"curscore",FormatNumber(Score(CurrentPlayer),0),1,""
		PuPlayer.LabelSet pBackglass,"curplayer","Player " & CurrentPlayer,1,""
		If CurrentPlayer = 1 Then
			PuPlayer.LabelSet pBackglass,"Play1score","" & FormatNumber(Score(CurrentPlayer),0),1,"{'mt':2,'color':16777215, 'size': 2.4 }"
			PuPlayer.LabelSet pBackglass,"Play1","Player 1",1,"{'mt':2,'color':16777215 }"
			'make other scores red (inactive)
			If PlayersPlayingGame = 2 Then
				PuPlayer.LabelSet pBackglass,"Play2score","" & FormatNumber(Score(2),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
				PuPlayer.LabelSet pBackglass,"Play2","Player 2",1,"{'mt':2,'color':8421504}"
			End If
			If PlayersPlayingGame = 3 Then
				PuPlayer.LabelSet pBackglass,"Play2score","" & FormatNumber(Score(2),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
				PuPlayer.LabelSet pBackglass,"Play2","Player 2",1,"{'mt':2,'color':8421504}"
				PuPlayer.LabelSet pBackglass,"Play3score","" & FormatNumber(Score(3),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
				PuPlayer.LabelSet pBackglass,"Play3","Player 3",1,"{'mt':2,'color':8421504}"
			End If
			If PlayersPlayingGame = 4 Then
				PuPlayer.LabelSet pBackglass,"Play2score","" & FormatNumber(Score(2),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
				PuPlayer.LabelSet pBackglass,"Play2","Player 2",1,"{'mt':2,'color':8421504}"
				PuPlayer.LabelSet pBackglass,"Play3score","" & FormatNumber(Score(3),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
				PuPlayer.LabelSet pBackglass,"Play3","Player 3",1,"{'mt':2,'color':8421504}"
				PuPlayer.LabelSet pBackglass,"Play4score","" & FormatNumber(Score(4),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
				PuPlayer.LabelSet pBackglass,"Play4","Player 4",1,"{'mt':2,'color':8421504}"
			End If
		End If
		If CurrentPlayer = 2 Then
			PuPlayer.LabelSet pBackglass,"Play2score","" & FormatNumber(Score(CurrentPlayer),0),1,"{'mt':2,'color':16777215, 'size': 2.4 }"
			PuPlayer.LabelSet pBackglass,"Play2","Player 2",1,"{'mt':2,'color':16777215 }"
			If PlayersPlayingGame = 2 Then
				PuPlayer.LabelSet pBackglass,"Play1score","" & FormatNumber(Score(1),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
				PuPlayer.LabelSet pBackglass,"Play1","Player 1",1,"{'mt':2,'color':8421504}"
			End If
			If PlayersPlayingGame = 3 Then
				PuPlayer.LabelSet pBackglass,"Play1score","" & FormatNumber(Score(1),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
				PuPlayer.LabelSet pBackglass,"Play1","Player 1",1,"{'mt':2,'color':8421504}"
				PuPlayer.LabelSet pBackglass,"Play3score","" & FormatNumber(Score(3),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
				PuPlayer.LabelSet pBackglass,"Play3","Player 3",1,"{'mt':2,'color':8421504}"
			End If
			If PlayersPlayingGame = 4 Then
				PuPlayer.LabelSet pBackglass,"Play1score","" & FormatNumber(Score(1),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
				PuPlayer.LabelSet pBackglass,"Play1","Player 1",1,"{'mt':2,'color':8421504}"
				PuPlayer.LabelSet pBackglass,"Play3score","" & FormatNumber(Score(3),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
				PuPlayer.LabelSet pBackglass,"Play3","Player 3",1,"{'mt':2,'color':8421504}"
				PuPlayer.LabelSet pBackglass,"Play4score","" & FormatNumber(Score(4),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
				PuPlayer.LabelSet pBackglass,"Play4","Player 4",1,"{'mt':2,'color':8421504}"
			End If
		End If
		If CurrentPlayer = 3 Then
			PuPlayer.LabelSet pBackglass,"Play3score","" & FormatNumber(Score(CurrentPlayer),0),1,"{'mt':2,'color':16777215, 'size': 2.4 }"
			PuPlayer.LabelSet pBackglass,"Play3","Player 3",1,"{'mt':2,'color':16777215 }"
			If PlayersPlayingGame = 3 Then
				PuPlayer.LabelSet pBackglass,"Play1score","" & FormatNumber(Score(1),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
				PuPlayer.LabelSet pBackglass,"Play1","Player 1",1,"{'mt':2,'color':8421504}"
				PuPlayer.LabelSet pBackglass,"Play2score","" & FormatNumber(Score(2),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
				PuPlayer.LabelSet pBackglass,"Play2","Player 2",1,"{'mt':2,'color':8421504}"
			End If
			If PlayersPlayingGame = 4 Then
				PuPlayer.LabelSet pBackglass,"Play1score","" & FormatNumber(Score(1),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
				PuPlayer.LabelSet pBackglass,"Play1","Player 1",1,"{'mt':2,'color':8421504}"
				PuPlayer.LabelSet pBackglass,"Play2score","" & FormatNumber(Score(2),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
				PuPlayer.LabelSet pBackglass,"Play2","Player 2",1,"{'mt':2,'color':8421504}"
				PuPlayer.LabelSet pBackglass,"Play4score","" & FormatNumber(Score(4),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
				PuPlayer.LabelSet pBackglass,"Play4","Player 4",1,"{'mt':2,'color':8421504}"
			End If
		End If
		If CurrentPlayer = 4 Then
			PuPlayer.LabelSet pBackglass,"Play4score","" & FormatNumber(Score(CurrentPlayer),0),1,"{'mt':2,'color':16777215, 'size': 2.4 }"
			PuPlayer.LabelSet pBackglass,"Play4","Player 4",1,"{'mt':2,'color':16777215 }"
			If PlayersPlayingGame = 4 Then
				PuPlayer.LabelSet pBackglass,"Play1score","" & FormatNumber(Score(1),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
				PuPlayer.LabelSet pBackglass,"Play1","Player 1",1,"{'mt':2,'color':8421504}"
				PuPlayer.LabelSet pBackglass,"Play2score","" & FormatNumber(Score(2),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
				PuPlayer.LabelSet pBackglass,"Play2","Player 2",1,"{'mt':2,'color':8421504}"
				PuPlayer.LabelSet pBackglass,"Play3score","" & FormatNumber(Score(3),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
				PuPlayer.LabelSet pBackglass,"Play3","Player 3",1,"{'mt':2,'color':8421504}"
			End If
		End If
	PuPlayer.LabelSet pBackglass,"Ball","Ball "  &  bpgcurrent - BallsRemaining(CurrentPlayer) + 1 ,1,""
	end Sub


'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  High Scores
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  


	Dim HSCheckFlag:HSCheckFlag = 0
	
	'UMLD
	Sub LoadHighScore
		WriteLog("Function=LoadHighScore")
		Dim x
		x = LoadValue(TableName, "HighScore1")
		If(x <> "") Then HighScore(0) = CDbl(x) Else HighScore(0) = 1300000 End If

		x = LoadValue(TableName, "HighScore1Name")
		If(x <> "") Then HighScoreName(0) = x Else HighScoreName(0) = "NO1" End If

		x = LoadValue(TableName, "HighScore2")
		If(x <> "") then HighScore(1) = CDbl(x) Else HighScore(1) = 1200000 End If

		x = LoadValue(TableName, "HighScore2Name")
		If(x <> "") then HighScoreName(1) = x Else HighScoreName(1) = "NO2" End If

		x = LoadValue(TableName, "HighScore3")
		If(x <> "") then HighScore(2) = CDbl(x) Else HighScore(2) = 1100000 End If

		x = LoadValue(TableName, "HighScore3Name")
		If(x <> "") then HighScoreName(2) = x Else HighScoreName(2) = "NO3" End If

		x = LoadValue(TableName, "HighScore4")
		If(x <> "") then HighScore(3) = CDbl(x) Else HighScore(3) = 1000000 End If

		x = LoadValue(TableName, "HighScore4Name")
		If(x <> "") then HighScoreName(3) = x Else HighScoreName(3) = "NO4" End If

		
		x = LoadValue(TableName, "Credits")
		If(x <> "") then Credits = CInt(x) Else Credits = 0 End If

		x = LoadValue(TableName, "TotalGamesPlayed")
		If(x <> "") then TotalGamesPlayed = CInt(x) Else TotalGamesPlayed = 0 End If

		If HSCheckFlag = 0 Then
			CheckHighScoreOrder
		End If
	End Sub

	

	'TODO NZ: Optimize this maybe
	Sub CheckHighScoreOrder
		WriteLog("Function=CheckHighScoreOrder")
		Dim hs3,hs2,hs1,hs0,hsn3,hsn2,hsn1,hsn0
		HSCheckFlag = 1
		hs3 = HighScore(3)
		hs2 = HighScore(2)
		hs1 = HighScore(1)
		hs0 = HighScore(0)
		hsn3 = HighScoreName(3)
		hsn2 = HighScoreName(2)
		hsn1 = HighScoreName(1)
		hsn0 = HighScoreName(0)
		If hs3 > hs0 Then
			HighScore(0) = hs3
			HighScoreName(0) = hsn3	
			HighScore(1) = hs0
			HighScoreName(1) = hsn0	
			HighScore(2) = hs1
			HighScoreName(2) = hsn1	
			HighScore(3) = hs2
			HighScoreName(3) = hsn2

		ElseIf hs3 > hs1 Then
			HighScore(0) = hs0
			HighScoreName(0) = hsn0	
			HighScore(1) = hs3
			HighScoreName(1) = hsn3	
			HighScore(2) = hs1
			HighScoreName(2) = hsn1	
			HighScore(3) = hs2
			HighScoreName(3) = hsn2
		ElseIf hs3 > hs2 Then
			HighScore(0) = hs0
			HighScoreName(0) = hsn0	
			HighScore(1) = hs1
			HighScoreName(1) = hsn1	
			HighScore(2) = hs3
			HighScoreName(2) = hsn3	
			HighScore(3) = hs2
			HighScoreName(3) = hsn2
		ElseIf hs3 < hs2 Then
			HighScore(0) = hs0
			HighScoreName(0) = hsn0	
			HighScore(1) = hs1
			HighScoreName(1) = hsn1	
			HighScore(2) = hs2
			HighScoreName(2) = hsn2	
			HighScore(3) = hs3
			HighScoreName(3) = hsn3
		End If

		SaveHighScore
	End Sub


	'UMLD
	Sub SaveHighScore
		WriteLog("Function=SaveHighScore")
	
		SaveValue TableName, "HighScore1", HighScore(0)
		SaveValue TableName, "HighScore1Name", HighScoreName(0)
		SaveValue TableName, "HighScore2", HighScore(1)
		SaveValue TableName, "HighScore2Name", HighScoreName(1)
		SaveValue TableName, "HighScore3", HighScore(2)
		SaveValue TableName, "HighScore3Name", HighScoreName(2)
		SaveValue TableName, "HighScore4", HighScore(3)
		SaveValue TableName, "HighScore4Name", HighScoreName(3)
	End Sub


	Sub SaveGamesPlayed
		SaveValue TableName, "TotalGamesPlayed", TotalGamesPlayed
		vpmtimer.addtimer 1000, "LoadHighScore'"
	End Sub


	' Initials

	Dim hsbModeActive:hsbModeActive = False
	Dim hsEnteredName
	Dim hsEnteredDigits(3)
	Dim hsCurrentDigit
	Dim hsValidLetters
	Dim hsCurrentLetter
	Dim hsLetterFlash
	Dim letterArray
	letterArray = Array("<","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z")

	' Check the scores to see if you got one

	Sub CheckHighscore()
		Dim tmp
		tmp = Score(CurrentPlayer)

		If tmp > HighScore(3) Then
			AwardSpecial
			vpmtimer.addtimer 2000, "PlaySound ""vo_contratulationsgreatscore"" '"
			HighScore(3) = tmp
			'enter player's name
			HighScoreEntryInit()
			DOF 403, DOFPulse   'DOF MX - Hi Score
		Else
			EndOfBallComplete
		End If
	End Sub


	Sub HighScoreEntryInit()
		hsbModeActive = True
		PlaySound "vo_enteryourinitials"

		hsEnteredDigits(1) = "A"
		hsEnteredDigits(2) = " "
		hsEnteredDigits(3) = " "

		hsCurrentDigit = 1

		pNote "YOU GOT","A HIGH SCORE!"
		PuPlayer.playlistplayex pCallouts,"audiocallouts","yougotahighscore.wav",100,1
		ChillOutTheMusic
		PuPlayer.playlistplayex pBackglass,"videohighscore","hs1.mov",100,7
		PuPlayer.SetLoop 2,1
		Playsound "bellhs"
		HighScoreDisplayName()
		HighScorelabels	
	End Sub

	' flipper moving around the letters

	Sub EnterHighScoreKey(KeyCode)
		If KeyCode = LeftFlipperKey Then
			Playsound "fx_Previous"
			If hsletter = 0 Then
				hsletter = 26
			Else
				hsLetter = hsLetter - 1
			End If
			HighScoreDisplayName()
		End If

		If KeyCode = RightFlipperKey Then
			Playsound "fx_Next"
			If hsletter = 26 Then
				hsletter = 0
			Else
				hsLetter = hsLetter + 1
			End If
			HighScoreDisplayName()
		End If

		If KeyCode = StartGameKey or KeyCode = PlungerKey Then
			PlaySound "success"
			If hsCurrentDigit = 3 Then
				If hsletter = 0 Then
					hsCurrentDigit = hsCurrentDigit -1
				Else
					AssignLetter
					vpmtimer.addtimer 700, "HighScoreCommitName()'"
					PuPlayer.playlistplayex pBackglass,"videobarb","clear.mov",100,7
				End If
			End If
			If hsCurrentDigit < 3 Then
				If hsletter = 0 Then
					If hsCurrentDigit = 1 Then
					Else
						hsCurrentDigit = hsCurrentDigit -1
					End If
				Else
					AssignLetter
					hsCurrentDigit = hsCurrentDigit + 1
					HighScoreDisplayName()

				End If
			End If
		End if
	End Sub

	Dim hsletter
	hsletter = 1

	dim hsdigit:hsdigit = 1

	Sub AssignLetter
		if hscurrentdigit = 1 Then
			hsdigit = 1
		End If
		if hscurrentdigit = 2 Then
			hsdigit = 2
		End If
		if hscurrentdigit = 3 Then
			hsdigit = 3
		End If
		'TODO NZ: make sure this works
		hsEnteredDigits(hsDigit) = letterArray(hsletter)
'		If hsletter = 1 Then 
'			hsEnteredDigits(hsdigit) = "A"
'		End If
'		If hsletter = 2 Then 
'			hsEnteredDigits(hsdigit) = "B"
'		End If
'		If hsletter = 3 Then 
'			hsEnteredDigits(hsdigit) = "C"
'		End If
'		If hsletter = 4 Then 
'			hsEnteredDigits(hsdigit) = "D"
'		End If
'		If hsletter = 5 Then 
'			hsEnteredDigits(hsdigit) = "E"
'		End If
'		If hsletter = 6 Then 
'			hsEnteredDigits(hsdigit) = "F"
'		End If
'		If hsletter = 7 Then 
'			hsEnteredDigits(hsdigit) = "G"
'		End If
'		If hsletter = 8 Then 
'			hsEnteredDigits(hsdigit) = "H"
'		End If
'		If hsletter = 9 Then 
'			hsEnteredDigits(hsdigit) = "I"
'		End If
'		If hsletter = 10 Then 
'			hsEnteredDigits(hsdigit) = "J"
'		End If
'		If hsletter = 11 Then 
'			hsEnteredDigits(hsdigit) = "K"
'		End If
'		If hsletter = 12 Then 
'			hsEnteredDigits(hsdigit) = "L"
'		End If
'		If hsletter = 13 Then 
'			hsEnteredDigits(hsdigit) = "M"
'		End If
'		If hsletter = 14 Then 
'			hsEnteredDigits(hsdigit) = "N"
'		End If
'		If hsletter = 15 Then 
'			hsEnteredDigits(hsdigit) = "O"
'		End If
'		If hsletter = 16 Then 
'			hsEnteredDigits(hsdigit) = "P"
'		End If
'		If hsletter = 17 Then 
'			hsEnteredDigits(hsdigit) = "Q"
'		End If
'		If hsletter = 18 Then 
'			hsEnteredDigits(hsdigit) = "R"
'		End If
'		If hsletter = 19 Then 
'			hsEnteredDigits(hsdigit) = "S"
'		End If
'		If hsletter = 20 Then 
'			hsEnteredDigits(hsdigit) = "T"
'		End If
'		If hsletter = 21 Then 
'			hsEnteredDigits(hsdigit) = "U"
'		End If
'		If hsletter = 22 Then 
'			hsEnteredDigits(hsdigit) = "V"
'		End If
'		If hsletter = 23 Then 
'			hsEnteredDigits(hsdigit) = "W"
'		End If
'		If hsletter = 24 Then 
'			hsEnteredDigits(hsdigit) = "X"
'		End If
'		If hsletter = 25 Then 
'			hsEnteredDigits(hsdigit) = "Y"
'		End If
'		If hsletter = 26 Then 
'			hsEnteredDigits(hsdigit) = "Z"
'		End If
'
	End Sub

	Sub HighScorelabels
		PuPlayer.LabelSet pBackglass,"HighScore","YOU GOT A\rHIGH SCORE!",1,""
		PuPlayer.LabelSet pBackglass,"HighScoreL1","A",1,""
		PuPlayer.LabelSet pBackglass,"HighScoreL2"," ",1,""
		PuPlayer.LabelSet pBackglass,"HighScoreL3"," ",1,""
		PuPlayer.LabelSet pBackglass,"HighScoreL4",Score(CurrentPlayer),1,""
		hsletter = 1
	End Sub

	Sub HighScoreDisplayName()
		WriteLog("Function=HighScoreDisplayName")
		'TODO NZ: Make sure this works
		PuPlayer.LabelSet pBackglass,"HighScoreL" & hsCurrentDigit, letterArray(hsLetter), 1, ""
		'Select case hsLetter
		'Case 0
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","<",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","<",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","<",1,""
		'Case 1
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","A",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","A",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","A",1,""
		'Case 2
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","B",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","B",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","B",1,""
		'Case 3
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","C",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","C",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","C",1,""
		'Case 4
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","D",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","D",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","D",1,""
		'Case 5
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","E",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","E",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","E",1,""
		'Case 6
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","F",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","F",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","F",1,""
		'Case 7
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","G",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","G",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","G",1,""
		'Case 8
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","H",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","H",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","H",1,""
		'Case 9
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","I",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","I",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","I",1,""
		'Case 10
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","J",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","J",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","J",1,""
		'Case 11
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","K",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","K",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","K",1,""
		'Case 12
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","L",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","L",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","L",1,""
		'Case 13
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","M",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","M",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","M",1,""
		'Case 14
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","N",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","N",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","N",1,""
		'Case 15
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","O",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","O",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","O",1,""
		'Case 16
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","P",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","P",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","P",1,""
		'Case 17
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","Q",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","Q",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","Q",1,""
		'Case 18
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","R",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","R",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","R",1,""
		'Case 19
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","S",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","S",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","S",1,""
		'Case 20
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","T",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","T",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","T",1,""
		'Case 21
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","U",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","U",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","U",1,""
		'Case 22
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","V",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","V",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","V",1,""
		'Case 23
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","W",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","W",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","W",1,""
		'Case 24
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","X",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","X",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","X",1,""
		'Case 25
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","Y",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","Y",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","Y",1,""
		'Case 26
		'	if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1","Z",1,""
		'	if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2","Z",1,""
		'	if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3","Z",1,""
		'End Select
	End Sub

	' post the high score letters


	Sub HighScoreCommitName()
		'TODO NZ: remove barb reference
		PuPlayer.playlistplayex pBackglass,"videobarb","clear.mov",100,7
		hsEnteredName = hsEnteredDigits(1) & hsEnteredDigits(2) & hsEnteredDigits(3)
		HighScoreName(3) = hsEnteredName
		CheckHighScoreOrder
		EndOfBallComplete()
		PuPlayer.LabelSet pBackglass,"HighScore","",1,""
		PuPlayer.LabelSet pBackglass,"HighScoreL1","",1,""
		PuPlayer.LabelSet pBackglass,"HighScoreL2"," ",1,""
		PuPlayer.LabelSet pBackglass,"HighScoreL3"," ",1,""
	End Sub



'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  ATTRACT MODE
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
' 

	'UMLD
	Sub StartAttractMode()
		WriteLog("Function=StartAttractMode")
		DOF 323, DOFOn   'DOF MX - Attract Mode ON
		bAttractMode = True
		UltraDMDTimer.Enabled = 1
		StartLightSeq
		'ShowTableInfo
		DMDIntroLoop
		
		StartRainbow alights
		StartAltRainbow GI
		IntroMover.enabled = true
		RulesHelperOff
	End Sub
	
	

	Sub StopAttractMode()
		WriteLog("Function=StopAttractMode")
		DOF 323, DOFOff   'DOF MX - Attract Mode Off
		bAttractMode = False
		DMDScoreNow
		LS_Attract.StopPlay
		LS_Attract2.StopPlay
		StopRainbow alights
		StopAltRainbow GI
		'ResetAllLightsColor
		IntroMover.enabled = false
		
	'StopSong
	End Sub



'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  CINEMATIC SKIPPING
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  


'	Dim ldown:ldown = 0
'	Dim rdown:rdown = 0
'
'	Sub checkdown
'		If ldown + rdown = 2 Then
'			skipscene
'		End If
'	End Sub
'
'	Sub skipscene
'
'	End Sub






'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  LIGHTING / RAINBOW LIGHTS
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
' 


	'********************************************************************************************
	' Only for VPX 10.2 and higher.
	' FlashForMs will blink light or a flasher for TotalPeriod(ms) at rate of BlinkPeriod(ms)
	' When TotalPeriod done, light or flasher will be set to FinalState value where
	' Final State values are:   0=Off, 1=On, 2=Return to previous State
	'********************************************************************************************

	'TODO NZ: this is not implemented
	Sub FlashForMs(MyLight, TotalPeriod, BlinkPeriod, FinalState) 'thanks gtxjoe for the first version
		If TypeName(MyLight) = "Light" Then

			If FinalState = 2 Then
				FinalState = MyLight.State 'Keep the current light state
			End If
			MyLight.BlinkInterval = BlinkPeriod
			MyLight.Duration 2, TotalPeriod, FinalState
		ElseIf TypeName(MyLight) = "Flasher" Then

			Dim steps

			' Store all blink information
			steps = Int(TotalPeriod / BlinkPeriod + .5) 'Number of ON/OFF steps to perform
			If FinalState = 2 Then                      'Keep the current flasher state
				FinalState = ABS(MyLight.Visible)
			End If
			MyLight.UserValue = steps * 10 + FinalState 'Store # of blinks, and final state

			' Start blink timer and create timer subroutine
			MyLight.TimerInterval = BlinkPeriod
			MyLight.TimerEnabled = 0
			MyLight.TimerEnabled = 1
			ExecuteGlobal "Sub " & MyLight.Name & "_Timer:" & "Dim tmp, steps, fstate:tmp=me.UserValue:fstate = tmp MOD 10:steps= tmp\10 -1:Me.Visible = steps MOD 2:me.UserValue = steps *10 + fstate:If Steps = 0 then Me.Visible = fstate:Me.TimerEnabled=0:End if:End Sub"
		End If
	End Sub

	'******************************************
	' Change light color - simulate color leds
	' changes the light color and state
	' 10 colors: red, orange, amber, yellow...
	'******************************************
	' in this table this colors are use to keep track of the progress during the acts and battles

	'colors
	Dim red, orange, amber, yellow, darkgreen, green, blue, darkblue, purple, white, base

	red = 10
	orange = 9
	amber = 8
	yellow = 7
	darkgreen = 6
	green = 5
	blue = 4
	darkblue = 3
	purple = 2
	white = 1
	base = 11

	Sub SetLightColor(n, col, state)
		Select Case col
			Case red
				n.color = RGB(255, 0, 0)
				n.colorfull = RGB(255, 0, 0)
			Case orange
				n.color = RGB(18, 3, 0)
				n.colorfull = RGB(255, 64, 0)
			Case amber
				n.color = RGB(193, 49, 0)
				n.colorfull = RGB(255, 153, 0)
			Case yellow
				n.color = RGB(18, 18, 0)
				n.colorfull = RGB(255, 255, 0)
			Case darkgreen
				n.color = RGB(0, 8, 0)
				n.colorfull = RGB(0, 64, 0)
			Case green
				n.color = RGB(0, 255, 0)
				n.colorfull = RGB(0, 255, 0)
			Case blue
				n.color = RGB(0, 18, 18)
				n.colorfull = RGB(0, 255, 255)
			Case darkblue
				n.color = RGB(0, 8, 8)
				n.colorfull = RGB(0, 64, 64)
			Case purple
				n.color = RGB(128, 0, 128)
				n.colorfull = RGB(255, 0, 255)
			Case white
				n.color = RGB(255, 252, 224)
				n.colorfull = RGB(193, 91, 0)
			Case white
				n.color = RGB(255, 252, 224)
				n.colorfull = RGB(193, 91, 0)
			Case base
				n.color = RGB(255, 197, 143)
				n.colorfull = RGB(255, 255, 236)
		End Select
		If state <> -1 Then
			n.State = 0
			n.State = state
		End If
	End Sub

	Sub ResetAllLightsColor ' Called at a new game
		'TODO NZ: fix this
		'SetLightColor l13, red, -1		
		'L_SLight.color = RGB(255,0,0):L_SLight.colorfull = RGB(255,0,0)
		'L_PLight.color = RGB(255,0,0):L_PLight.colorfull = RGB(255,0,0)
		'L_LLight.color = RGB(255,0,0):L_LLight.colorfull = RGB(255,0,0)
		
		SetLightColor L_SLight, red, 1
		SetLightColor L_PLight, red, 1
		SetLightColor L_LLight, red, 1
		
		SetLightColor L_StreamOrbital1, green, 1
		SetLightColor L_StreamOrbital2, green, 1
		SetLightColor L_StreamOrbital3, green, 1
		
		SetLightColor L_BumperLeft, green, 1
		SetLightColor L_BumperRight, green, 1
		SetLightColor L_BumperLower, green, 1
		
		SetLightColor L_DT_UpperLeft, red, 1
		SetLightColor L_DT_UpperRight, red, 1
		SetLightColor L_DT_UpperCenter, red, 1
		
		SetLightColor L_DT_LowerLeft, blue, 1
		SetLightColor L_DT_LowerCenter, blue, 1
		SetLightColor L_DT_LowerRight, blue, 1
		
		SetLightColor L_ObjectiveA, yellow, 1
		SetLightColor L_ObjectiveB, yellow, 1
		SetLightColor L_ObjectiveC, yellow, 1
		SetLightColor L_ObjectiveD, yellow, 1
		SetLightColor L_ObjectiveE, yellow, 1
		
		SetLightColor L_LowerObjectiveAchieved, green, 1
		SetLightColor L_UpperObjectiveAchieved, green, 1
		SetLightColor L_StreamOrbitAchieved, green, 1
		SetLightColor L_AllTargetsAchieved, green, 1
		
	End Sub

	Sub UpdateBonusColors
	End Sub

	'*************************
	' Rainbow Changing Lights
	'*************************

	Dim RGBStep, RGBFactor, rRed, rGreen, rBlue, RainbowLights
	'UMLD
	Sub StartRainbow(n)
		set RainbowLights = n
		RGBStep = 0
		RGBFactor = 5
		rRed = 255
		rGreen = 0
		rBlue = 0
		RainbowTimer.Enabled = 1
	End Sub

	Dim AltRGBStep, AltRGBFactor, AltrRed, AltrGreen, AltrBlue, AltRainbowLights
	'UMLD	
	Sub StartAltRainbow(n)
		set AltRainbowLights = n
		AltRGBStep = 0
		AltRGBFactor = 5
		AltrRed = 255
		AltrGreen = 0
		AltrBlue = 0
		AltRainbowTimer.Enabled = 1
	End Sub

	Sub StopRainbow(n)
		Dim obj
		RainbowTimer.Enabled = 0
		RainbowTimer.Enabled = 0
			For each obj in RainbowLights
				SetLightColor obj, "white", 0
			Next
	End Sub

	Sub StopAltRainbow(n)
		Dim obj
		AltRainbowTimer.Enabled = 0
			For each obj in AltRainbowLights
				SetLightColor obj, "white", 0
				obj.state = 1
				obj.Intensity = 15
			Next
	End Sub

	Sub RainbowTimer_Timer 'rainbow led light color changing
		Dim obj
		Select Case RGBStep
			Case 0 'Green
				rGreen = rGreen + RGBFactor
				If rGreen > 255 then
					rGreen = 255
					RGBStep = 1
				End If
			Case 1 'Red
				rRed = rRed - RGBFactor
				If rRed < 0 then
					rRed = 0
					RGBStep = 2
				End If
			Case 2 'Blue
				rBlue = rBlue + RGBFactor
				If rBlue > 255 then
					rBlue = 255
					RGBStep = 3
				End If
			Case 3 'Green
				rGreen = rGreen - RGBFactor
				If rGreen < 0 then
					rGreen = 0
					RGBStep = 4
				End If
			Case 4 'Red
				rRed = rRed + RGBFactor
				If rRed > 255 then
					rRed = 255
					RGBStep = 5
				End If
			Case 5 'Blue
				rBlue = rBlue - RGBFactor
				If rBlue < 0 then
					rBlue = 0
					RGBStep = 0
				End If
		End Select
			For each obj in RainbowLights
				obj.color = RGB(rRed \ 10, rGreen \ 10, rBlue \ 10)
				obj.colorfull = RGB(rRed, rGreen, rBlue)
			Next
	End Sub

	Sub AltRainbowTimer_Timer 'rainbow led light color changing
		Dim obj
		Select Case AltRGBStep
			Case 0 'Green
				AltrGreen = AltrGreen + AltRGBFactor
				If AltrGreen > 255 then
					AltrGreen = 255
					AltRGBStep = 1
				End If
			Case 1 'Red
				AltrRed = AltrRed - AltRGBFactor
				If AltrRed < 0 then
					AltrRed = 0
					AltRGBStep = 2
				End If
			Case 2 'Blue
				AltrBlue = AltrBlue + AltRGBFactor
				If AltrBlue > 255 then
					AltrBlue = 255
					AltRGBStep = 3
				End If
			Case 3 'Green
				AltrGreen = AltrGreen - AltRGBFactor
				If AltrGreen < 0 then
					AltrGreen = 0
					AltRGBStep = 4
				End If
			Case 4 'Red
				AltrRed = AltrRed + AltRGBFactor
				If AltrRed > 255 then
					AltrRed = 255
					AltRGBStep = 5
				End If
			Case 5 'Blue
				AltrBlue = AltrBlue - AltRGBFactor
				If AltrBlue < 0 then
					AltrBlue = 0
					AltRGBStep = 0
				End If
		End Select
			For each obj in AltRainbowLights
				obj.color = RGB(AltrRed \ 10, AltrGreen \ 10, AltrBlue \ 10)
				obj.colorfull = RGB(AltrRed, AltrGreen, AltrBlue)
			Next
	End Sub

	'UMLD
	Sub StartLightSeq()
		Dim a
		For each a in alights
			a.State = 1
		Next
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqUpOn, 50, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqDownOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqCircleOutOn, 15, 2
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqUpOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqDownOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqUpOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqDownOn, 25, 1
		LS_Attract.UpdateInterval = 10
		LS_Attract.Play SeqCircleOutOn, 15, 3
		LS_Attract.UpdateInterval = 5
		LS_Attract.Play SeqRightOn, 50, 1
		LS_Attract.UpdateInterval = 5
		LS_Attract.Play SeqLeftOn, 50, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqRightOn, 50, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqLeftOn, 50, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqRightOn, 40, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqLeftOn, 40, 1
		LS_Attract.UpdateInterval = 10
		LS_Attract.Play SeqRightOn, 30, 1
		LS_Attract.UpdateInterval = 10
		LS_Attract.Play SeqLeftOn, 30, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqRightOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqLeftOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqRightOn, 15, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqLeftOn, 15, 1
		LS_Attract.UpdateInterval = 10
		LS_Attract.Play SeqCircleOutOn, 15, 3
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqLeftOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqRightOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqLeftOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqUpOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqDownOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqUpOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqDownOn, 25, 1
		LS_Attract.UpdateInterval = 5
		LS_Attract.Play SeqStripe1VertOn, 50, 2
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqCircleOutOn, 15, 2
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqStripe1VertOn, 50, 3
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqLeftOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqRightOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqLeftOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqUpOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqDownOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqCircleOutOn, 15, 2
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqStripe2VertOn, 50, 3
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqLeftOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqRightOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqLeftOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqUpOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqDownOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqUpOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqDownOn, 25, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqStripe1VertOn, 25, 3
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqStripe2VertOn, 25, 3
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqUpOn, 15, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqDownOn, 15, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqUpOn, 15, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqDownOn, 15, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqUpOn, 15, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqDownOn, 15, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqRightOn, 15, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqLeftOn, 15, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqRightOn, 15, 1
		LS_Attract.UpdateInterval = 8
		LS_Attract.Play SeqLeftOn, 15, 1
		For each a in GI
			a.State = 1
			a.Intensity = 80
		Next
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqUpOn, 50, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqDownOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqCircleOutOn, 15, 2
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqUpOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqDownOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqUpOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqDownOn, 25, 1
		LS_Attract2.UpdateInterval = 10
		LS_Attract2.Play SeqCircleOutOn, 15, 3
		LS_Attract2.UpdateInterval = 5
		LS_Attract2.Play SeqRightOn, 50, 1
		LS_Attract2.UpdateInterval = 5
		LS_Attract2.Play SeqLeftOn, 50, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqRightOn, 50, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqLeftOn, 50, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqRightOn, 40, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqLeftOn, 40, 1
		LS_Attract2.UpdateInterval = 10
		LS_Attract2.Play SeqRightOn, 30, 1
		LS_Attract2.UpdateInterval = 10
		LS_Attract2.Play SeqLeftOn, 30, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqRightOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqLeftOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqRightOn, 15, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqLeftOn, 15, 1
		LS_Attract2.UpdateInterval = 10
		LS_Attract2.Play SeqCircleOutOn, 15, 3
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqLeftOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqRightOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqLeftOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqUpOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqDownOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqUpOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqDownOn, 25, 1
		LS_Attract2.UpdateInterval = 5
		LS_Attract2.Play SeqStripe1VertOn, 50, 2
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqCircleOutOn, 15, 2
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqStripe1VertOn, 50, 3
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqLeftOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqRightOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqLeftOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqUpOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqDownOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqCircleOutOn, 15, 2
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqStripe2VertOn, 50, 3
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqLeftOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqRightOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqLeftOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqUpOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqDownOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqUpOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqDownOn, 25, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqStripe1VertOn, 25, 3
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqStripe2VertOn, 25, 3
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqUpOn, 15, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqDownOn, 15, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqUpOn, 15, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqDownOn, 15, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqUpOn, 15, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqDownOn, 15, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqRightOn, 15, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqLeftOn, 15, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqRightOn, 15, 1
		LS_Attract2.UpdateInterval = 8
		LS_Attract2.Play SeqLeftOn, 15, 1
	End Sub

	Sub LS_Attract_PlayDone()
		StartLightSeq()
	End Sub

	Sub LS_Tilt_PlayDone()
		LS_Tilt.Play SeqAllOff
	End Sub

	Sub LS_Skillshot_PlayDone()
		LS_Skillshot.Play SeqAllOff
	End Sub



	'**********************
	'     GI effects
	' independent routine
	' it turns on the gi
	' when there is a ball
	' in play
	'**********************

	Dim OldGiState
	OldGiState = -1   'start witht the Gi off

	Sub ChangeGi(col) 'changes the gi color
		Dim bulb
		For each bulb in GI
			SetLightColor bulb, col, -1
		Next
	End Sub

'	Sub GIUpdateTimer_Timer
'		Dim tmp, obj
'		tmp = Getballs
'		If UBound(tmp) <> OldGiState Then
'			OldGiState = Ubound(tmp)
'			If UBound(tmp) = 3 Then 'we have 4 captive balls on the table (-1 means no balls, 0 is the first ball, 1 is the second..)
'				'GiOff               ' turn off the gi if no active balls on the table, we could also have used the variable ballsonplayfield.
'			Else
'				'Gion
'			End If
'		End If
'	End Sub

	Sub GiOn
		WriteLog("Function=GiOn")
		DOF 126, DOFOn
		Dim bulb
		For each bulb in GI
			SetLightColor bulb, base, -1
			bulb.State = 1
		Next
	End Sub

	Sub GiOff
		WriteLog("Function=GiOff")
		DOF 126, DOFOff
		Dim bulb
		For each bulb in GI
			bulb.State = 0
		Next
	End Sub


	' GI & light sequence effects

	'TODO NZ: reimplment this stuff maybe
	Sub GiEffect(n)
		WriteLog("Function=GiEffect Param=" & n)
		Select Case n
			Case 0 'all off
				'LightSeqGi.Play SeqAlloff
			Case 1 'all blink
				'LightSeqGi.UpdateInterval = 4
				'LightSeqGi.Play SeqBlinking, , 5, 100
			Case 2 'random
				'LightSeqGi.UpdateInterval = 10
				'LightSeqGi.Play SeqRandom, 5, , 1000
			Case 3 'upon
				'LightSeqGi.UpdateInterval = 4
				'LightSeqGi.Play SeqUpOn, 5, 1
			Case 4 ' left-right-left
				'LightSeqGi.UpdateInterval = 5
				'LightSeqGi.Play SeqLeftOn, 10, 1
				'LightSeqGi.UpdateInterval = 5
				'LightSeqGi.Play SeqRightOn, 10, 1
		End Select
	End Sub

	'TODO NZ: reimplment this stuff maybe
	Sub LightEffect(n)
		WriteLog("Function=LightEffect Param=" & n)
		Select Case n
			Case 0 ' all off
				'LightSeqInserts.Play SeqAlloff
			Case 1 'all blink
				'LightSeqInserts.UpdateInterval = 4
				'LightSeqInserts.Play SeqBlinking, , 5, 100
			Case 2 'random
				'LightSeqInserts.UpdateInterval = 10
				'LightSeqInserts.Play SeqRandom, 5, , 1000
			Case 3 'upon
				'LightSeqInserts.UpdateInterval = 4
				'LightSeqInserts.Play SeqUpOn, 10, 1
			Case 4 ' left-right-left
				'LightSeqInserts.UpdateInterval = 5
				'LightSeqInserts.Play SeqLeftOn, 10, 1
				'LightSeqInserts.UpdateInterval = 5
				'LightSeqInserts.Play SeqRightOn, 10, 1
			Case 5 'random
				'LightSeqbumper.UpdateInterval = 4
				'LightSeqbumper.Play SeqBlinking, , 5, 10
				LS_Bumpers.UpdateInterval = 4
				LS_Bumpers.Play SeqBlinking, , 5, 10
			Case 6 'random
				'LightSeqRSling.UpdateInterval = 4
				'LightSeqRSling.Play SeqBlinking, , 5, 6
			Case 7 'random
				'LightSeqLSling.UpdateInterval = 4
				'LightSeqLSling.Play SeqBlinking, , 5, 6
			Case 8 'random
				'LightSeqBack.UpdateInterval = 4
				'LightSeqBack.Play SeqBlinking, , 5, 6
			Case 12 'random
				'LightSeqlr.UpdateInterval = 4
				'LightSeqlr.Play SeqBlinking, , 5, 10
		End Select
	End Sub

	' Flasher Effects using lights

	Dim FEStep, FEffect
	FEStep = 0
	FEffect = 0
	'TODO NZ: reimplment this stuff maybe
	Sub FlashEffect(n)
		Select case n
			Case 0 ' all off
				LightSeqFlasher.Play SeqAlloff
			Case 1 'all blink
				LightSeqFlasher.UpdateInterval = 4
				LightSeqFlasher.Play SeqBlinking, , 5, 100
			Case 2 'random
				LightSeqFlasher.UpdateInterval = 10
				LightSeqFlasher.Play SeqRandom, 5, , 1000
			Case 3 'upon
				LightSeqFlasher.UpdateInterval = 4
				LightSeqFlasher.Play SeqUpOn, 10, 1
			Case 4 ' left-right-left
				LightSeqFlasher.UpdateInterval = 5
				LightSeqFlasher.Play SeqLeftOn, 10, 1
				LightSeqFlasher.UpdateInterval = 5
				LightSeqFlasher.Play SeqRightOn, 10, 1
			Case 5 ' top flashers blink fast
		End Select
	End Sub







	'****************************
	' Flashers - Thanks Flupper
	'****************************

'	Dim FlashLevel1, FlashLevel2, FlashLevel3, FlashLevel4, FlashLevel5, FlashLevel6
'	Flasherlight4.IntensityScale = 0

	'*** right red flasher ***
'	Sub Flasherflash3_Timer()
'		dim flashx3, matdim
'		If not Flasherflash3.TimerEnabled Then 
'			Flasherflash3.TimerEnabled = True
'			Flasherflash3.visible = 1
'			Flasherlit3.visible = 1
'		End If
'		flashx3 = FlashLevel3 * FlashLevel3 * FlashLevel3
'		Flasherflash3.opacity = 1500 * flashx3
'		Flasherlit3.BlendDisableLighting = 10 * flashx3
'		Flasherbase3.BlendDisableLighting =  flashx3
'		Flasherlight4.IntensityScale = flashx3
'		matdim = Round(10 * FlashLevel3)
'		Flasherlit3.material = "domelit" & matdim
'		FlashLevel3 = FlashLevel3 * 0.9 - 0.01
'		If FlashLevel3 < 0.15 Then
'			Flasherlit3.visible = 0
'		Else
'			Flasherlit3.visible = 1
'		end If
'		If FlashLevel3 < 0 Then
'			Flasherflash3.TimerEnabled = False
'			Flasherflash3.visible = 0
'		End If
'	End Sub




'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'   SCORING FUNCTIONS
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  

	Sub AddScore(points)
		WriteLog("Function=AddScore Param=" & points)
		If(Tilted = False) Then
			' add the points to the current players score variable
			Score(CurrentPlayer) = Score(CurrentPlayer) + points
			DMDScore
			pUpdateScores
		End if
	End Sub
	
	Sub AddBonus(points)
		'TODO NZ: This stuff
		
	End Sub

	'TODO NZ: reimplment this
	Sub AwardExtraBall()
		WriteLog("Function=AwardExtraBall")
		If NOT bExtraBallWonThisBall Then
			LightShootAgain.State = 1
			'flashflash.Enabled = True
			LightSeqFlasher.UpdateInterval = 150
			LightSeqFlasher.Play SeqRandom, 10, , 10000
			ExtraBallsAwards(CurrentPlayer) = ExtraBallsAwards(CurrentPlayer) + 1
			bExtraBallWonThisBall = True
			DOF 402, DOFPulse   'DOF MX - Extra Ball
			'extraballready(CurrentPlayer) = 0
			If bMultiBallMode = false Then
				PuPlayer.playlistplayex pBackglass,"videoextraball","extraballsm.mov",100,1
				PuPlayer.playlistplayex pCallouts,"audiocallouts","extraball.wav",100,1
				ChillOutTheMusic
			End If
		Else
			AddScore 4000000
		END If
	End Sub

	Sub AwardSpecial()
		WriteLog("Function=AwardSpecial")
		Credits = Credits + 1
		DOF 140, DOFOn
		PlaySound SoundFXDOF("knocker",136,DOFPulse,DOFKnocker)		
		DOF 115, DOFPulse
		GiEffect 1
		LightEffect 1
		DOF 400, DOFPulse   'DOF MX - Special
	End Sub

	'TODO NZ: reimplment this stuff maybe
	Sub AwardSkillshot()
		WriteLog("Function=AwardSkillshot")
		Dim i
		DOF 125, DOFPulse
		ResetSkillShotTimer_Timer
		AddScore SkillshotValue(CurrentPLayer)
		GiEffect 1
		LightEffect 2
		LightEffect 9
		DOF 401, DOFPulse   'DOF MX - Skillshot
		PuPlayer.playlistplayex pCallouts,"audiocallouts","skillshot.wav",100,1
		ChillOutTheMusic
		PuPlayer.playlistplayex pBackglass,"videoskillshot","",100,3
		pNote "SKILLSHOT",SkillShotValue(CurrentPLayer)
		SkillShotValue(CurrentPLayer) = SkillShotValue(CurrentPLayer) + 1000000
	End Sub



'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'   BALL FUNCTIONS & DRAINS
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  


	Function Balls
		Dim tmp
		tmp = bpgcurrent - BallsRemaining(CurrentPlayer) + 1
		If tmp> bpgcurrent Then
			Balls = bpgcurrent
		Else
			Balls = tmp
		End If
	End Function


	Sub FirstBall()
		WriteLog("Function=FirstBall")
		WriteLog("Function=FirstBall Calling=ResetForNewPlayerBall")
		ResetForNewPlayerBall()
		WriteLog("Function=FirstBall Calling=CreateNewBall")
		CreateNewBall false
	End Sub


	Sub ResetForNewPlayerBall()
		WriteLog("Function=ResetForNewPlayerBall")
		PuPlayer.playresume 4
		Dim vpFile, apFile
		If PlayersPlayingGame > 1 Then
			WriteLog("Function=ResetForNewPlayerBall Note='More than 1 player in the game'")
			vpFile = "player" & CurrentPlayer & "sm.mov"
			apFile = "player" & CurrentPlayer & ".wav"
			
			If CurrentPlayer = 1 Then
				vpFile = "player" & CurrentPlayer & "sm1.mov"
			End If

			PuPlayer.playlistplayex pBackglass,"videoplayers",vpFile,40,1
			PuPlayer.playlistplayex pCallouts,"audiocallouts",apFile,70,1
			ChillOutTheMusic
		Else
			WriteLog("Function=ResetForNewPlayerBall Note='Single Player Game'")
			pNote "BALL " & Balls,"LAUNCH BALL"
			'PlaySound "flute"
			PuPlayer.playlistplayex pCallouts,"audiocallouts","oneplayergame.wav",70,1
		End If
		AddScore 0
		ResetTableElements
		ResetNewBallLights
		ResetNewBallVariables
		
		'TODO NZ: Evaluate how this gets used
		
	End Sub


	Sub CreateNewBall(isFromLockBall)
		WriteLog("Function=CreateNewBall isFromLockBall=" & isFromLockBall)
		BallsOnPlayfield = BallsOnPlayfield + 1
		PuPlayer.LabelSet pBackglass,"lefttimer",BallsOnPlayfield,1,""		
		If isFromLockBall Then
			KI_MultiballLaunch.CreateSizedball BallSize / 2
			'TODO NZ: fix this to play sound at bumpers
			PlaySoundAt SoundFXDOF("fx_Ballrel", 114, DOFPulse, DOFContactors), KI_MultiballLaunch
			KI_MultiballLaunch.Kick 180, 30
		Else 
			'TODO NZ: different situation if from lockball - create at the multiball kicker'
			KI_Plunger.CreateSizedball BallSize / 2
			PlaySoundAt SoundFXDOF("fx_Ballrel", 114, DOFPulse, DOFContactors), KI_Plunger
			KI_Plunger.Kick 90, 4
			If BallsOnPlayfield > 1 Then
				bMultiBallMode = True
				DOF 127, DOFOn    'Beacon ON
				bAutoPlunger = True
			End If
		End If
	End Sub


	Sub AddMultiball(nballs)
		mBalls2Eject = mBalls2Eject + nballs
		CreateMultiballTimer.Enabled = True
	End Sub

	Sub CreateMultiballTimer_Timer()
		WriteLog("Function=CreateMultiballTimer_Timer")
		If bBallInPlungerLane Then
			WriteLog("Function=CreateMultiballTimer_Timer Note='Balls in plunger lane, not launching")
			Exit Sub
		Else
			If BallsOnPlayfield < MaxMultiballs Then
				WriteLog("Function=CreateMultiballTimer_Timer Note='Creating a new ball from the launcher'")
				CreateNewBall true
				PuPlayer.LabelSet pBackglass,"lefttimer",BallsOnPlayfield,1,""				
				mBalls2Eject = mBalls2Eject -1
				If mBalls2Eject = 0 Then 
					Me.Enabled = False
				End If
			Else 
				WriteLog("Function=CreateMultiballTimer_Timer Note='too many balls on playfield'")
				mBalls2Eject = 0
				Me.Enabled = False
			End If
		End If
	End Sub

	Sub EndOfBall()
		PuPlayer.playlistplayex pAudio,"audiomultiballs","clear.mp3",100,1


		bMultiBallMode = False
		bOnTheFirstBall = False
		vpmtimer.addtimer 500, "EndOfBall2 '"

	End Sub

	
	Sub EndOfBall2()
		Tilted = False
		Tilt = 0
		DisableTable False


		If(ExtraBallsAwards(CurrentPlayer) <> 0) Then
			ExtraBallsAwards(CurrentPlayer) = ExtraBallsAwards(CurrentPlayer) - 1
			If(ExtraBallsAwards(CurrentPlayer) = 0) Then
				LightShootAgain.State = 0
			End If
			LightSeqFlasher.UpdateInterval = 150
			LightSeqFlasher.Play SeqRandom, 10, , 2000

			CreateNewBall false
			ResetForNewPlayerBall
			PuPlayer.playlistplayex pBackglass,"videoextraball","isthatsupposedtoimpress.mov",100,2
			pNote "SHOOT AGAIN","SAME PLAYER"
			PuPlayer.playlistplayex pCallouts,"audiocallouts","shootagain.wav",100,1
			ChillOutTheMusic
		Else
			BallsRemaining(CurrentPlayer) = BallsRemaining(CurrentPlayer) - 1
			If(BallsRemaining(CurrentPlayer) <= 0) Then
				CheckHighScore()
			Else
				EndOfBallComplete()
			End If
		End If
	End Sub

	Sub EndOfBallComplete()
		ResetNewBallVariables
		Dim NextPlayer
		If(PlayersPlayingGame> 1) Then
			NextPlayer = CurrentPlayer + 1
			If(NextPlayer> PlayersPlayingGame) Then
				NextPlayer = 1
			End If
		Else
			NextPlayer = CurrentPlayer
		End If
		If((BallsRemaining(CurrentPlayer) <= 0) AND(BallsRemaining(NextPlayer) <= 0) ) Then
			EndOfGame()
		Else
			CurrentPlayer = NextPlayer
			AddScore 0
			ResetForNewPlayerBall()
			CreateNewBall false
			If PlayersPlayingGame> 1 Then
				PlaySound "vo_player" &CurrentPlayer
			End If
		End If
	End Sub

	Sub BallDrained
		DOF 312, DOFPulse
		PuPlayer.playlistplayex pMusic,"audioclear","clear.mp3",100, 1
		PuPlayer.playlistplayex pBackglass,"videodrain","",100,1
	End Sub

	Sub Drain_Hit()
		WriteLog("Function=Drain_Hit")
		Drain.DestroyBall
		BallsOnPlayfield = BallsOnPlayfield - 1
		PuPlayer.LabelSet pBackglass,"lefttimer",BallsOnPlayfield,1,""
		'PlaySoundAt "fx_drain", Drain
		If Tilted Then
			StopEndOfBallMode
		End If
		If(bGameInPLay = True) AND(Tilted = False) Then
			If(bBallSaverActive = True) Then
				WriteLog("Function=Drain_Hit Note='bBallSaverActive is true.. launching a new ball'")
				AddMultiball 1
				bAutoPlunger = True
				If bMultiBallMode = False Then
					'Ballsaved
					'PuPlayer.playlistplayex pCallouts,"audiocallouts","ballsaved.wav",100,1
					'ChillOutTheMusic
					'pNote "BALL SAVED",""
					'PuPlayer.playlistplayex pBackglass,"videoballsaved","",100,1
				End If
			Else
				If(BallsOnPlayfield = 1) Then
					If(bMultiBallMode = True) then
						DOF 127, DOFOff   'DOF - Beacon - OFF
					End If
					bMultiBallMode = False
					ChangeGi "white"
					ResetUpperDropTargets
					ResetLowerDropTargets
				End If
			
				If(BallsOnPlayfield = 0) Then
					bMultiBallMode = False
					ChangeGi "white"
					KI_RightLockball.DestroyBall
					KI_LeftLockball.DestroyBall

					vpmtimer.addtimer 1000, "BallDrained '"
					vpmtimer.addtimer 6000, "EndOfBall '"
					StopEndOfBallMode
				End If
			End If
		End If
	End Sub

	

'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  BALL SAVE & LAUNCH
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
' 
	'TODO NZ: implement this
'	Sub ballsavestarttrigger_hit
'		If(bBallSaverReady = True) AND(15 <> 0) And(bBallSaverActive = False) Then
'			EnableBallSaver 15
'		End If
'	End Sub

'	Sub swPlungerRest_Hit()
'TR_BallLaunch
'		PlaySoundAt "fx_sensor", ActiveBall
'		bBallInPlungerLane = True
'		If bAutoPlunger Then
'			DOF 114, DOFPulse		
'			DOF 115, DOFPulse
'			DOF 318, DOFPulse
'			bAutoPlunger = False
'		End If
'		DOF 141, DOFOn
'		DOF 317, DOFOn
'		If bSkillShotReady Then
'			swPlungerRest.TimerEnabled = 1
'			UpdateSkillshot()
'		End If
'		LastSwitchHit = "swPlungerRest"
'	End Sub
'
'
'	Sub swPlungerRest_UnHit()
'		bBallInPlungerLane = False
'		swPlungerRest.TimerEnabled = 0 'stop the launch ball timer if active
'		If bSkillShotReady Then
'			ResetSkillShotTimer.Enabled = 1
'		End If
'		DOF 317, DOFOff   'DOF MX - Ball is ready to Launch - OFF
'	End Sub
'
'
'	Sub swPlungerRest_Timer
'		'DMD "start-5.wmv", "", "",  6000
'		swPlungerRest.TimerEnabled = 0
'	End Sub
'
	'TODO NZ: implement this
	Sub EnableBallSaver(seconds)
		bBallSaverActive = True
		bBallSaverReady = False
		BallSaverTimerExpired.Interval = 1000 * seconds
		BallSaverTimerExpired.Enabled = True
		BallSaverSpeedUpTimer.Interval = 1000 * seconds -(1000 * seconds) / 3
		BallSaverSpeedUpTimer.Enabled = True
		' if you have a ball saver light you might want to turn it on at this point (or make it flash)
		LightShootAgain.BlinkInterval = 160
		LightShootAgain.State = 2
	End Sub

	' The ball saver timer has expired.  Turn it off AND reset the game flag
	'
	Sub BallSaverTimerExpired_Timer()
		'debug.print "Ballsaver ended"
		BallSaverTimerExpired.Enabled = False
		' clear the flag
		Dim waittime
		waittime = 4000
		vpmtimer.addtimer waittime, "BallSaveGrace'"
		' if you have a ball saver light then turn it off at this point
		If bExtraBallWonThisBall = True Then
			LightShootAgain.State = 1
		Else
			LightShootAgain.State = 0
		End If
	End Sub

	Sub BallSaveGrace
		bBallSaverActive = False
	End Sub

	Sub BallSaverSpeedUpTimer_Timer()
		'debug.print "Ballsaver Speed Up Light"
		BallSaverSpeedUpTimer.Enabled = False
		' Speed up the blinking
		LightShootAgain.BlinkInterval = 80
		LightShootAgain.State = 2
	End Sub

'********************************************************************************************************************************************
'********************************************************************************************************************************************
'********************************************************************************************************************************************
'********************************************************************************************************************************************
'********************************************************************************************************************************************
'FRAMEWORK BASE CODE END HERE
'********************************************************************************************************************************************
'********************************************************************************************************************************************
'********************************************************************************************************************************************
'********************************************************************************************************************************************
'********************************************************************************************************************************************

'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  ATTRACT MODE
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
' 


	Dim IntroPosition
	IntroPosition = 0

	'UMLD
	Sub DMDIntroLoop
		WriteLog("Function=DMDIntroLoop Note='IntroPosition=" & IntroPosition & "'")
		PuPlayer.LabelSet pBackglass,"modetitle","",1,"{'mt':2,'color':16777215, 'size': 0, 'xpos': 80.7, 'xalign': 1, 'ypos': 72.6, 'yalign': 0}"
		IntroTime = 0	
		IntroPosition = IntroPosition + 1
		Select Case IntroPosition
		Case 1
			PuPlayer.LabelSet pBackglass,"HighScore","",1,""
			PuPlayer.LabelSet pBackglass,"HighScoreL1","",1,""
			PuPlayer.LabelSet pBackglass,"HighScoreL2","",1,""
			PuPlayer.LabelSet pBackglass,"HighScoreL3","",1,""
			PuPlayer.playlistplayex pMusic,"audioclear","clear.mp3",100, 1
			PuPlayer.playlistplayex pBackglass,"videoattract","backglass.jpg",100,1
			PuPlayer.LabelSet pBackglass,"notetitle","Need Rules Help?",1,""
			PuPlayer.LabelSet pBackglass,"notecopy","Hold both flippers for 2 seconds while in attract mode for rules overlay.",1,""
			PuPlayer.LabelSet pBackglass,"high1name","",1,""
			PuPlayer.LabelSet pBackglass,"high1score","",1,""
			PuPlayer.LabelSet pBackglass,"high2name","",1,""
			PuPlayer.LabelSet pBackglass,"high2score","",1,""
			PuPlayer.LabelSet pBackglass,"high3name","",1,""
			PuPlayer.LabelSet pBackglass,"high3score","",1,""
			PuPlayer.LabelSet pBackglass,"high4name","",1,""
			PuPlayer.LabelSet pBackglass,"high4score","",1,""
		Case 2
			LoadHighScore
			PuPlayer.playlistplayex pMusic,"audiobgrock","",99,1
			PuPlayer.LabelSet pBackglass,"HighScore","",1,""
			PuPlayer.LabelSet pBackglass,"HighScoreL1","",1,""
			PuPlayer.LabelSet pBackglass,"HighScoreL2","",1,""
			PuPlayer.LabelSet pBackglass,"HighScoreL3","",1,""
			PuPlayer.LabelSet pBackglass,"notetitle","Got A killer good High Score?",1,""
			PuPlayer.LabelSet pBackglass,"notecopy","Post it to #stlevpx on instagram to brag.",1,""
			PuPlayer.playlistplayex pBackglass,"videoattract","backglass.jpg",100,1
			PuPlayer.LabelSet pBackglass,"high1name",HighScoreName(0),1,""
			PuPlayer.LabelSet pBackglass,"high1score",FormatNumber(HighScore(0),0),1,""
			PuPlayer.LabelSet pBackglass,"high2name",HighScoreName(1),1,""
			PuPlayer.LabelSet pBackglass,"high2score",FormatNumber(HighScore(1),0),1,""
			PuPlayer.LabelSet pBackglass,"high3name",HighScoreName(2),1,""
			PuPlayer.LabelSet pBackglass,"high3score",FormatNumber(HighScore(2),0),1,""
			PuPlayer.LabelSet pBackglass,"high4name",HighScoreName(3),1,""
			PuPlayer.LabelSet pBackglass,"high4score",FormatNumber(HighScore(3),0),1,""
		Case 3
			PuPlayer.playlistplayex pBackglass,"videoattract","backglass.jpg",100,1
			PuPlayer.LabelSet pBackglass,"notetitle","Did You Know?",1,""
			PuPlayer.LabelSet pBackglass,"HighScore","",1,""
			PuPlayer.LabelSet pBackglass,"HighScoreL1","",1,""
			PuPlayer.LabelSet pBackglass,"HighScoreL2","",1,""
			PuPlayer.LabelSet pBackglass,"HighScoreL3","",1,""
			PuPlayer.LabelSet pBackglass,"notecopy","You can change the music to 80s jams in the script? Check it out..",1,""
			PuPlayer.LabelSet pBackglass,"high1name","",1,""
			PuPlayer.LabelSet pBackglass,"high1score","",1,""
			PuPlayer.LabelSet pBackglass,"high2name","",1,""
			PuPlayer.LabelSet pBackglass,"high2score","",1,""
			PuPlayer.LabelSet pBackglass,"high3name","",1,""
			PuPlayer.LabelSet pBackglass,"high3score","",1,""
			PuPlayer.LabelSet pBackglass,"high4name","",1,""
			PuPlayer.LabelSet pBackglass,"high4score","",1,""
		Case 4
			PuPlayer.LabelSet pBackglass,"notetitle","Want to code your own original table?",1,""
			PuPlayer.LabelSet pBackglass,"notecopy","Check Scottywics YouTube Channel for helpful guides.",1,""
			PuPlayer.playlistplayex pBackglass,"videoattract","backglass.jpg",100,1

		Case 5
			PuPlayer.playlistplayex pBackglass,"videoattract","backglass.jpg",100,1
			PuPlayer.LabelSet pBackglass,"notetitle","Be Excellent to Each Other",1,""
			PuPlayer.LabelSet pBackglass,"notecopy","There is no place for homophobia, fascism, sexism, racism or hate.",1,""
			IntroPosition = 0
		End Select
	End Sub


	Dim IntroTime
	IntroTime = 0

	Sub IntroMover_timer
		IntroTime = IntroTime + 1
		If IntroPosition = 1 Then
			If IntroTime = 47 Then
				DMDIntroLoop
			End If
		End If
		If IntroPosition = 2 Then
			If IntroTime = 13 Then
				DMDIntroLoop
			End If
		End If
		If IntroPosition = 3 Then
			If IntroTime = 13 Then
				DMDIntroLoop
			End If
		End If
		If IntroPosition = 4 Then
			If IntroTime = 9 Then
				DMDIntroLoop
			End If
		End If
		If IntroPosition = 0 Then
			If IntroTime = 9 Then
				IntroPosition = 0
				DMDIntroLoop
			End If
		End If
	End Sub



'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  GAME STARTING & RESETS
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
' 

	Sub Game_Init() 'called at the start of a new game
		WriteLog("Function=Game_Init")
		Dim i
		For i = 0 to 4
			SkillshotValue(i) = 1000000 ' increases by 1000000 each time it is collected
		Next
		bExtraBallWonThisBall = False
		PuPlayer.LabelSet pBackglass,"high1name","",1,""
		PuPlayer.LabelSet pBackglass,"high1score","",1,""
		PuPlayer.LabelSet pBackglass,"high2name","",1,""
		PuPlayer.LabelSet pBackglass,"high2score","",1,""
		PuPlayer.LabelSet pBackglass,"high3name","",1,""
		PuPlayer.LabelSet pBackglass,"high3score","",1,""
		PuPlayer.LabelSet pBackglass,"high4name","",1,""
		PuPlayer.LabelSet pBackglass,"high4score","",1,""
		PuPlayer.LabelShowPage pBackglass,1,0,""
		pUpdateScores
		PuPlayer.playlistplayex pBackglass,"scene","base.mov",0,1
		PuPlayer.SetBackground pBackglass,1
		PuPlayer.LabelSet pBackglass,"Play1","PLAYER 1",1,"{'mt':2,'color':16777215}"
		PuPlayer.LabelSet pBackglass,"notetitle","",1,""
		PuPlayer.LabelSet pBackglass,"notecopy","",1,""
		RulesHelperOn
		ResetBackGlass
	End Sub

	Sub StopEndOfBallMode()              'this sub is called after the last ball is drained
		ResetSkillShotTimer_Timer
	End Sub

	Sub ResetNewBallVariables()
		BonusPoints(CurrentPlayer) = 0
		BumperHitCount = 0 
		StreamOrbitCount = 0
		bBonusHeld = False
		bExtraBallWonThisBall = False
		bBallSaverReady = True
		bSkillShotReady = False	
		bMultiBallMode = False
		JackpotActive = False
		Invincibility = False
		RightOutlaneSaverMode = False
		LeftOutlaneSaverMode = False
		PowerupRampMode = False
		Dim i
		For i = 0 to 3
			PlayfieldObjectives(i) = 0
		Next
		For i = 0 to 4
			TargetObjectives(i) = 0
		Next
		UpperPlayfieldDTsHit = False
		LowerPlayfieldDTsHit = False
		RightLockballMode = false
		LeftLockballMode = false
		RightLockballArmed = false
		LeftLockballArmed = false
		
		
	End Sub

	Sub TurnOffPlayfieldLights()
		WriteLog("Function=TurnOffPlayfieldLights")
		Dim a
		For each a in alights
			'WriteLog("Function=TurnOffPlayfieldLights Note='turning off a light'")
			a.State = 0
		Next
	End Sub

	Sub TurnOnPlayfieldLights()
		WriteLog("Function=TurnOnPlayfieldLights")
		Dim a
		For each a in alights
			a.State = 1
		Next
	End Sub
	
	Sub ResetNewBallLights() 'turn on or off the needed lights before a new ball is released
		WriteLog("Function=ResetNewBallLights")
		TurnOffPlayfieldLights()
		TurnOnPlayfieldLights()
		'Dim l
		

		'For each l in SPLLaneLights
		'	l.state = 0
		'Next

		
		'For each l in OrbitalLights
		'	l.state = 0
		'Next
		
		'For each l in TargetObjectiveLights
		'	l.state = 0
		'Next

		'For each l in UpperDropTargetLights
		'	l.state = 0
		'Next

		'For each l in LowerDropTargetLights
		'	l.state = 0
		'Next
		
		'For each l in PlayfieldObjectiveLights
		'	l.state = 0
		'Next
		
		'currentplayerbackglass
	End Sub


	Sub ResetTableElements
	'TODO NZ: write this.  reset all drop targets, etc
		ResetUpperDropTargets
		ResetLowerDropTargets
		SetLeftLockball false
		SetRightLockball false
		SetJackpot false
	End Sub
	
	
	Sub UpdateSkillShot() 'Updates the skillshot light
		'TODO NZ: fix light references
		'l7.State = 2
	End Sub

	Sub SkillshotOff_Hit 'trigger to stop the skillshot due to a weak plunger shot
		If bSkillShotReady Then
			ResetSkillShotTimer_Timer
		End If
	End Sub

	Sub ResetSkillShotTimer_Timer 'timer to reset the skillshot lights & variables
		ResetSkillShotTimer.Enabled = 0
		bSkillShotReady = False
		'TODO NZ: fix light references
		'If l7.State = 2 then l7.State = 0
	End Sub


'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  RULES HELPER FOR YOUR BACKGLASS
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
' 


	Sub RulesHelperOn
		RulesTimer.enabled = 1
	End Sub

	'UMLD
	Sub RulesHelperOff
		RulesTimer.enabled = 0
	End Sub

	Dim RulesPosition
	RulesPosition = 0

	
	Sub RulesTimer_Timer
		If TurnOffRules = 1 then exit sub end if
		RulesPosition = RulesPosition + 1
		Select Case RulesPosition
		Case 1
			PuPlayer.LabelSet pBackglass,"notetitle","Write SPL and Onboard Data",1,""
			PuPlayer.LabelSet pBackglass,"notecopy","Hit the SPL lanes and bumpers",1,""
		Case 8
			PuPlayer.LabelSet pBackglass,"notetitle","Hit Targets for Bonus Points",1,""
			PuPlayer.LabelSet pBackglass,"notecopy","IoCs, Threats, Anomalies, Events, and Metrics!",1,""
		Case 15
			PuPlayer.LabelSet pBackglass,"notetitle","Expand Your Data Sources",1,""
			PuPlayer.LabelSet pBackglass,"notecopy","The drop targets will make the ball locks available",1,""
		Case 24
			PuPlayer.LabelSet pBackglass,"notetitle","Upgrade to Premium Apps!",1,""
			PuPlayer.LabelSet pBackglass,"notecopy","Enterprise Security and IT Service Intelligence are available once all data sources acquired",1,""
		Case 32
			PuPlayer.LabelSet pBackglass,"notetitle","Reduce Incident MTTR and MTTI",1,""
			PuPlayer.LabelSet pBackglass,"notecopy","If you get both premium apps and hit incident, you will get multiball!",1,""
		Case 40
			PuPlayer.LabelSet pBackglass,"notetitle","Get That Network Data",1,""
			PuPlayer.LabelSet pBackglass,"notecopy","Hit the stream ramp 3 times for invincibility and to unlock the jackpot",1,""
		Case 48
			PuPlayer.LabelSet pBackglass,"notetitle","Try A Skillshot",1,""
			PuPlayer.LabelSet pBackglass,"notecopy","The top skillshot lane will reset your kickback, and if jackpot is active will award jackpot",1,""
		Case 56
			RulesPosition = 0
	End Select
	End Sub



'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  SECONDARY HIT EVENTS
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
' 

	Dim RStep, Lstep

	Sub W_RightSS_Slingshot
		WriteLog("Function=W_RightSS_Slingshot")
		PlaySoundAt SoundFXDOF("RightSlingShot", 103, DOFPulse, DOFContactors), TR_RightInLane
		'PlaySound SoundFX("RightSlingShot",DOFContactors), 0,1, 0.05,0.05 '0,1, AudioPan(RightSlingShot), 0.05,0,0,1,AudioFade(RightSlingShot)
		RB_RightSS2.Visible = 1

		P_RightSSKicker.TransZ = -20
		RStep = 0
		W_RightSS.TimerEnabled = 1

	End Sub

	Sub W_RightSS_Timer
		Select Case RStep
			Case 3:RB_RightSS2.Visible = 0:RB_RightSS3.Visible = 1:P_RightSSKicker.TransZ = -10
			Case 4:RB_RightSS3.Visible = 0:P_RightSSKicker.TransZ = 0:W_RightSS.TimerEnabled = 0
		End Select
		RStep = RStep + 1
	End Sub

	Sub W_LeftSS_Slingshot
		WriteLog("Function=W_LeftSS_Slingshot")
		PlaySoundAt SoundFXDOF("LeftSlingShot", 103, DOFPulse, DOFContactors), TR_LeftInlane
		'PlaySound SoundFX("LeftSlingShot",DOFContactors), 0,1, -0.05,0.05 '0,1, AudioPan(LeftSlingShot), 0.05,0,0,1,AudioFade(LeftSlingShot)
		RB_LeftSS2.Visible = 1
		P_LeftSSKicker.TransZ = -20
		LStep = 0
		W_LeftSS.TimerEnabled = 1

	End Sub

	Sub W_LeftSS_Timer
		Select Case LStep
			Case 3:RB_LeftSS2.Visible = 0:RB_LeftSS3.Visible = 1:P_LeftSSKicker.TransZ = -10
			Case 4:RB_LeftSS3.Visible = 0:P_LeftSSKicker.TransZ = 0:W_LeftSS.TimerEnabled = 0
		End Select
		LStep = LStep + 1
	End Sub


	Sub RotateLaneLightsLeft
		Dim TempState
		TempState = L_SLight.State
		L_SLight.State = L_PLight.State
		L_PLight.State = L_LLight.State
		L_LLight.State = TempState
	End Sub

	Sub RotateLaneLightsRight
		Dim TempState
		TempState = L_LLight.State
		L_LLight.State = L_PLight.State
		L_PLight.State = L_SLight.State
		L_SLight.State = TempState
	End Sub



'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  Make sure all the components on your table that will be objectives 
'  are part of the "GameTargets" collection
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
' 
	'Sub ProcessHit(component)
	Sub GameTargets_Hit(idx)
		Dim component
		Set component = GameTargets(idx)
		WriteLog("Function=GameTarget_Hit Component=" & component.Name)
		If NOT Tilted Then
			Select Case component.Name
			'''''''''''''''TOP LANES''''''''''''''''
			Case "TR_TopLaneLeft":
				AddScore(5)
				ToggleTopLane("S")
			Case "TR_TopLaneCenter":
				AddScore(5)
				ToggleTopLane("P")
			Case "TR_TopLaneRight":
				AddScore(5)
				ToggleTopLane("L")
				
				
			'''''''''''''''UPPER DROP TARGETS''''''''''''''''
			Case "DT_UpperLeft":
				L_DT_UpperLeft.State = 1
				vpmtimer.AddTimer 250, "CheckUpperDropTargets()'"
			Case "DT_UpperCenter":
				L_DT_UpperCenter.State = 1
				vpmtimer.AddTimer 250, "CheckUpperDropTargets()'"
			Case "DT_UpperRight":
				L_DT_UpperRight.State = 1
				vpmtimer.AddTimer 250, "CheckUpperDropTargets()'"
				
				
			'''''''''''''''LOWER DROP TARGETS''''''''''''''''
			Case "DT_LowerLeft":
				L_DT_LowerLeft.State = 1
				vpmtimer.AddTimer 250, "CheckLowerDropTargets() '"
			Case "DT_LowerCenter":
				L_DT_LowerCenter.State = 1
				vpmtimer.AddTimer 250, "CheckLowerDropTargets() '"
			Case "DT_LowerRight":
				L_DT_LowerRight.State = 1
				vpmtimer.AddTimer 250, "CheckLowerDropTargets() '"

			'''''''''''''''SKILLSHOT''''''''''''''''				
			Case "TR_SkillShot":
				If JackpotActive Then
					'TODO NZ: award jackpot, flash lights, etc
					AddScore(1000)
					SetJackpot false
				Else
					AddScore(50)
				End If					
				
				
			'''''''''''''''LOCKBALLS''''''''''''''''
			Case "DT_RightLockball":
				AddScore(100)
				If NOT bMultiBallMode Then
					WriteLog("Function=DT_RightLockball Note='Its not multiball'")
					If RightLockballMode AND RightLockballArmed Then
						vpmtimer.addtimer 500, "SetRightLockballDT true '"					
					Else 
						vpmtimer.addtimer 15000, "SetRightLockballDT true '"
					End If
				End If

			Case "KI_RightLockball":
				RightLockballArmed = true
				BallsOnPlayField = BallsOnPlayField - 1
				PuPlayer.LabelSet pBackglass,"lefttimer",BallsOnPlayfield,1,""
				
				If RightLockballMode Then
					WriteLog("Function KI_RightLockball Note='right lockball mode is enabled'")
					L_MultiballLocked2.State = 1
					CheckMultiBallReady
					vpmtimer.addtimer 1000, "CreateNewBall true '"
					ObtainPlayfieldObjective(LowerPlayfieldObjective)
					'TODO NZ: dof/lights'
					'TODO NZ: create a new ball '
				Else
					WriteLog("Function KI_RightLockball Note='right lockball mode is disabled'")
					AddScore(100)
					'TODO NZ: dof/lights
					vpmtimer.addtimer 500, "KickRightLockball '"
					
				End If
				
			Case "KI_LeftLockball":
				LeftLockballArmed = true
				BallsOnPlayField = BallsOnPlayField - 1
				PuPlayer.LabelSet pBackglass,"lefttimer",BallsOnPlayfield,1,""
				If LeftLockballMode Then
					WriteLog("Function=KI_LeftLockball_Hit Note='lockball mode is enabled'")
					L_MultiballLocked1.State = 1
					CheckMultiBallReady
					vpmtimer.addtimer 1000, "CreateNewBall true '"
					ObtainPlayfieldObjective(UpperPlayfieldObjective)
					'TODO NZ: dof/sound/etc
					'TODO NZ: create a new ball '

				Else
					WriteLog("Function=KI_LeftLockball_Hit Note='lockball mode is disabled'")
					AddScore(100)
					vpmtimer.addtimer 500, "KickLeftLockball '"

					'TODO NZ dof
				End If
				
			Case "KI_Multiball":
				If LeftLockballArmed AND RightLockballArmed Then
					WriteLog("Multiball activated!")
					WriteLog("Balls on playfield at start of multiball = " & BallsOnPlayField)
					'TODO NZ: dof/lights/go crazy
					KI_Multiball.DestroyBall
					BallsOnPlayField = BallsOnPlayField - 1
					PuPlayer.LabelSet pBackglass,"lefttimer",BallsOnPlayfield,1,""
					WriteLog("Balls on playfield after first destroy = " & BallsOnPlayField)
					
					AddScore(1000)
					AddMultiball 2
					vpmtimer.addtimer 5000, "KickLeftLockball() '"
					vpmtimer.addtimer 6000, "KickRightLockball() '"
				Else
					AddScore(100)
					KI_Multiball.Kick 270, 40
				End If
					
				
				

			'''''''''''''''BUMPERS''''''''''''''''
			Case "B_Left":
				LightEffect 5
				PlaySoundAt SoundFXDOF("fx_bumper", 107, DOFPulse, DOFContactors), ActiveBall
				DOF 110, DOFPulse
				DOF 302, DOFPulse   'DOF MX - Bumper 1
				AddScore(1)
				BumperHitCount = BumperHitCount + 1
				CheckBumperHitCount


			Case "B_Right":
				LightEffect 5
				PlaySoundAt SoundFXDOF("fx_bumper", 109, DOFPulse, DOFContactors), ActiveBall
				DOF 111, DOFPulse
				DOF 303, DOFPulse   'DOF MX - Bumper 2
				AddScore(1)
				BumperHitCount = BumperHitCount + 1
				CheckBumperHitCount

			Case "B_Lower":
				LightEffect 5
				PlaySoundAt SoundFXDOF("fx_bumper", 108, DOFPulse, DOFContactors), ActiveBall
				DOF 112, DOFPulse
				DOF 304, DOFPulse   'DOF MX - Bumper 3
				AddScore(1)
				BumperHitCount = BumperHitCount + 1
				CheckBumperHitCount


			'''''''''''''''INLANES''''''''''''''''
			Case "TR_LeftInlane":
				PlaySoundAt "fx_sensor", ActiveBall
				If bMultiBallMode = False Then
					PlaySound "lane"
					DOF 144, DOFPulse
					DOF 313, DOFPulse   'DOF MX - Left Outer Lane
				End If
				AddScore 100
				If NOT Invincibility AND Not bBallSaverActive Then
					SetRightOutlaneSaver(True)
					vpmtimer.AddTimer 10000, "SetRightOutlaneSaver False '"
				End If
				' Do some sound or light effect
				'LastSwitchHit = "lane1"

			Case "TR_RightInlane":
				PlaySoundAt "fx_sensor", ActiveBall
				If bMultiBallMode = False Then
					PlaySound "lane"
					DOF 144, DOFPulse
					DOF 313, DOFPulse   'DOF MX - Left Outer Lane
				End If
				AddScore 100
				If NOT Invincibility AND Not bBallSaverActive Then
					SetLeftOutlaneSaver(True)
					vpmtimer.AddTimer 10000, "SetLeftOutlaneSaver False '"
				End If
				' Do some sound or light effect
				'LastSwitchHit = "lane1"
			
			Case "TR_LeftLockball":
				'TODO NZ: dof/lights/etc
				AddScore(100)
				'AddBonus(100)
				

			'''''''''''''''ORBITS''''''''''''''''
			Case "GA_PowerupRamp":
				If PowerupRampMode Then
					StreamOrbitCount = StreamOrbitCount + 1
					Dim i
					For i = 1 to StreamOrbitCount
						OrbitalLights(i-1).State = 1
					Next 
					WriteLog("Function=GA_PowerupRamp_Hit StreamOrbitCount=" & StreamOrbitCount)			
					If StreamOrbitCount >= 3 Then
						ObtainPlayfieldObjective(OrbitPlayfieldObjective) 
						StreamOrbitCount = 0
						ActivateInvincibility(10)
						If NOT JackpotActive Then
							WriteLog("Function=GA_PowerupRamp_Hit Note='Jackpot active from powerup ramp'")
							SetJackpot true
							'TODO NZ: dof/sound/etc
						End If
						For i = 1 to 3
							OrbitalLights(i-1).State = 0
						Next
					End If
				Else 
					WriteLog("Function=GA_PowerupRamp_Hit Note='powerup ramp not active'")
				End If
			Case "TR_PowerupRamp":
				'nothing to do here yet.  maybe some dof/lights/pup'
			
			
			'''''''''''''''TARGETS''''''''''''''''
			Case "TA_ObjectiveA":
				ObtainTargetObjective(TargetObjectiveA)
			Case "TA_ObjectiveB":
				ObtainTargetObjective(TargetObjectiveB)
			Case "TA_ObjectiveC":
				ObtainTargetObjective(TargetObjectiveC)
			Case "TA_ObjectiveD":
				ObtainTargetObjective(TargetObjectiveD)
			Case "TA_ObjectiveE":				
				ObtainTargetObjective(TargetObjectiveE)

			'''''''''''''''OUTLANES''''''''''''''''
			Case "KI_LeftOutlaneSaver":
				KI_LeftOutlaneSaver.Kick 0, 50
				'TODO NZ: Animate P_LeftOutlaneSaver

			Case "TR_RightOutlane":
				If NOT Invincibility Then
					If RightOutlaneSaverMode Then
						vpmtimer.AddTimer 1000, "SetRightOutlaneSaver false '"
					Else
						'assign points going to drain
					End If
					
				Else
					'play a sound for invincible saved
				End If

			Case "TR_LeftOutlane":
				'TODO NZ: assign points and disable saver maybe
				If NOT Invincibility Then
					If LeftOutlaneSaverMode Then
						'play some music "you got saved!"
						vpmtimer.AddTimer 1000, "SetLeftOutlaneSaver false '"
					Else
						'assign points, going to drain
					End If
					
				Else 
					'play a sound for invincible kickback
				End If
				
				
			'''''''''''''''PLUNGER''''''''''''''''
			Case "TR_PlungerLaneExit":
				vpmTimer.AddTimer 1000, "SetPowerupRamp(true) '"
				bBallInPlungerLane = false
				SetBallSaverMode True, 10000

			Case "TR_BallLaunch":
				'TODO NZ: need to figure out how to auto plunger the ball out
				SetPowerupRamp(false)
				PlaySoundAt "fx_sensor", ActiveBall
				bBallInPlungerLane = True
				If bAutoPlunger Then
					DOF 114, DOFPulse		
					DOF 115, DOFPulse
					DOF 318, DOFPulse
					bAutoPlunger = False
					
				End If
				
				'Plunger.AutoPlunger = True
				'Plunger.Pullback
				'Plunger.Fire

			End Select	
		End If
	End Sub
	

'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  Shot helper functions
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
' 


'---------DROP TARGET HELPERS-----------
	Sub CheckUpperDropTargets
		If LeftLockballMode Then 'automatically re-raise targets if already in lockball mode
			WriteLog("Function=CheckUpperDropTargets Note='Left Lockball mode is armed, resetting immediately'")
			ResetUpperDropTargets
			AddScore(100)
		Else 
			If DT_UpperLeft.IsDropped = 1 AND DT_UpperCenter.IsDropped = 1 AND DT_UpperRight.IsDropped = 1 Then
				WriteLog("Function=CheckUpperDropTargets Note='All targets are dropped'")
				SetLeftLockball(true)
				ResetUpperDropTargets
				AddScore(50)
				'TODO NZ: dof to tell folks left kicker is lockable
			Else
				AddScore(10)
				'WriteLog("Function=CheckUpperDropTargets Note='Not all targets are dropped'")
				'WriteLog("Function=CheckUpperDropTargets DT_UpperLeft.IsDropped=" & DT_UpperLeft.IsDropped)
				'WriteLog("Function=CheckUpperDropTargets DT_UpperCenter.IsDropped=" & DT_UpperCenter.IsDropped)
				'WriteLog("Function=CheckUpperDropTargets DT_UpperRight.IsDropped=" & DT_UpperRight.IsDropped)
			End If
		End If
	End Sub
	
	Sub CheckLowerDropTargets
		If RightLockballMode Then 
			WriteLog("Function=CheckLowerDropTargets Note='Right Lockball mode is armed, resetting immediately'")
			ResetLowerDropTargets
			AddScore(100)
		Else
			If DT_LowerLeft.IsDropped = 1 AND DT_LowerCenter.IsDropped = 1 AND DT_LowerRight.IsDropped = 1 Then
				WriteLog("Function=CheckLowerDropTargets Note='All targets are dropped'")
				SetRightLockball(true)
				ResetLowerDropTargets
				AddScore(50)
				'TODO NZ: dof to tell folks left kicker is lockable
			Else
				AddScore(10)
				'WriteLog("Function=CheckUpperDropTargets Note='Not all targets are dropped'")
				'WriteLog("Function=CheckUpperDropTargets DT_UpperLeft.IsDropped=" & DT_UpperLeft.IsDropped)
				'WriteLog("Function=CheckUpperDropTargets DT_UpperCenter.IsDropped=" & DT_UpperCenter.IsDropped)
				'WriteLog("Function=CheckUpperDropTargets DT_UpperRight.IsDropped=" & DT_UpperRight.IsDropped)
			End If
		End If
	End Sub
	
	Sub SetRightLockballDT(mode) 'mode = true = DT enabled (up).  mode = false = DT disabled (down)
		WriteLog("Function=SetRightLockballDT mode=" & mode)
		If mode Then
			If RightLockballArmed AND NOT RightLockballMode Then
				WriteLog("Function=SetRightLockballDT Note='Couldn't raise right lockball droptarget because the kicker is armed.  will try again in 1 second'")
				vpmtimer.addtimer 1000, "SetRightLockballDT true '"
			Else 
				DT_RightLockball.IsDropped = 0
				L_LowerLockballGate.State = 0
			End If
		Else
			L_LowerLockballGate.State = 1
			DT_RightLockball.IsDropped = 1
		End If	
	End Sub
	
	
	Sub ResetUpperDropTargets
		DT_UpperLeft.IsDropped = 0
		DT_UpperCenter.IsDropped = 0
		DT_UpperRight.IsDropped = 0
		L_DT_UpperLeft.State = 0
		L_DT_UpperCenter.State = 0
		L_DT_UpperRight.State = 0	
	End Sub
	
	Sub ResetLowerDropTargets
		DT_LowerLeft.IsDropped = 0
		DT_LowerCenter.IsDropped = 0
		DT_LowerRight.IsDropped = 0
		L_DT_LowerLeft.State = 0
		L_DT_LowerCenter.State = 0
		L_DT_LowerRight.State = 0	
	End Sub	
	
	
	
'---------LOCK BALL HELPERS-----------
	Sub SetLeftLockball(mode)
		If mode Then
			'TODO NZ: dof/pup
			LeftLockballMode = true
			L_LeftLockballReady.State = 1
		Else 
			LeftLockballMode = false
			L_LeftLockballReady.State = 0
		End If			
	End Sub

	Sub SetRightLockball(mode)
		If mode Then
			'TODO NZ: dof/pup
			RightLockballMode = true
			L_RightLockbalLReady.State = 1
		Else 
			RightLockballMode = false
			L_RightLockballReady.State = 0
		End If			
	End Sub
	
	Sub KickLeftLockball
		BallsOnPlayField = BallsOnPlayField + 1
		PuPlayer.LabelSet pBackglass,"lefttimer",BallsOnPlayfield,1,""
		
		KI_LeftLockball.Kick 180,20
		LeftLockballArmed = false
	End Sub
	
	Sub KickRightLockball
		BallsOnPlayField = BallsOnPlayField + 1
		PuPlayer.LabelSet pBackglass,"lefttimer",BallsOnPlayfield,1,""		
		SetRightLockballDT false
		vpmtimer.addtimer 500, "SetRightLockballDT true '"
		KI_RightLockball.Kick 180,20
		RightLockballArmed = false
	End Sub
	
	
'---------OBJECTIVE HELPERS-----------
	Sub ObtainPlayfieldObjective(objectiveNumber)
		PlayfieldObjectives(objectiveNumber) = 1
		Dim isTableObjectiveAchieved' = true
		isTableObjectiveAchieved = true
		Dim i
		For i = 0 to 3
			If PlayfieldObjectives(i) = 0 Then
				isTableObjectiveAchieved = false
				PlayfieldObjectiveLights(i).State = 0
			Else
				PlayfieldObjectiveLights(i).State = 1
			End If
		Next
		
		If isTableObjectiveAchieved Then
			'TODO NZ: award lots of points, pup, dof, etc
			AddScore(1000)
			For i = 0 to 3
				PlayfieldObjectives(i) = 0
				PlayfieldObjectiveLights(i).State = 0
			Next
		End If
			
	
	End Sub

	Sub ObtainTargetObjective(objectiveNumber)
		WriteLog("Function=ObtainTargetObjective ObjectiveNumber="  & objectiveNumber)
		'TODO NZ: fix this object reference'
		TargetObjectiveLights(objectiveNumber).State = 1
		TargetObjectives(objectiveNumber) = 1
		Dim isTargetObjectiveAchieved'
		isTargetObjectiveAchieved = true
		Dim i
		For i = 0 to 4
			WriteLog("TargetObjective(" & i & ") = " & TargetObjectives(i))
			If TargetObjectives(i) = 0 Then
				isTargetObjectiveAchieved = false
			End If
		Next

		If isTargetObjectiveAchieved Then
			WriteLog("Function=ObtainTargetObjective Note='Target objectives complete, setting jackpot to true'")
			SetJackpot true
			ObtainPlayfieldObjective(TargetsPlayfieldObjective)
			AddScore(1000)
			ResetTargetObjectives
				
			'TODO NZ: dof/lights/etc
		Else
			WriteLog("Function=ObtainTargetObjective Note='Target objectives NOT complete'")
		End If
	End Sub

	Sub ResetTargetObjectives
		Dim i
		For i = 0 to 4
			TargetObjectives(i) = 0
		Next
		For each i in TargetObjectiveLights
			i.State = 0
		Next
	End Sub
	
	Sub SetJackpot(mode) 
		JackpotActive = mode
		If mode Then
			L_JackpotReady.State = 2
			L_JackpotReady.BlinkInterval = 500
			'TODO NZ: play some stuff and flash some lights to indicate jackpot is active
		Else
			L_JackpotReady.State = 0
		End If
	
	End Sub
	
'---------LANE HELPERS-----------	
	Sub SetLeftOutlaneSaver(mode)
		WriteLog("Function=SetLeftOutlaneSaver mode=" & mode)
		LeftOutlaneSaverMode = mode
		If mode Then
			
			KI_LeftOutlaneSaver.Enabled = mode
			If Not Invincibility Then
				L_LeftOutlane.State = 1
				'TODO NZ: turn on light, play sound, dof
			End If
		Else
			If Not Invincibility Then
				KI_LeftOutlaneSaver.Enabled = mode
				L_LeftOutlane.State = 0
			End If
			'TODO NZ: turn on light, play sound, dof
		End If		
	
	End Sub
	
	Sub SetRightOutlaneSaver(mode)
		WriteLog("Function=SetRightOutlaneSaver mode=" & mode)
		RightOutlaneSaverMode = mode
		
		'TODO NZ: turn on light, play sound, dof
		If mode Then
			If Not Invincibility Then
				L_RightOutlane.State = 1
				'Play sound
			End If
			FL_RightOutlaneSaver.RotateToEnd
			
		Else
			If Not Invincibility Then
				L_RightOutlane.State = 0
				'Play sound
			End If
			FL_RightOutlaneSaver.RotateToStart
			
		End If
	End Sub
	
	Sub ToggleTopLane(laneLetter)
		Select Case laneLetter
		Case "S":
			If L_SLight.State = 0 Then 
				'L_SLight.State = 1 
				SetLightColor L_SLight, red, 1
				'L_SLight.State = 1
			Else 
				L_SLight.State = 0
			End If
		Case "P":
			If L_PLight.State = 0 Then 
				L_PLight.State = 1 
			Else
				L_PLight.State = 0
			End If
		Case "L":
			If L_LLight.State = 0 Then 
				L_LLight.State = 1 
			Else
				L_LLight.State = 0
			End If
		End Select
		
		If L_SLight.State = 1 AND L_PLight.State = 1 AND L_LLight.State = 1 Then
			WriteLog("Function=ToggleTopLane Note='All top lane lights ative.  Increasing bonus multiplier." )
			L_SLight.State = 0
			L_PLight.State = 0
			L_LLight.State = 0
			AddScore(100)
			If BonusMultiplier(CurrentPlayer) < MaxMultiplier Then
				BonusMultiplier(CurrentPlayer) = BonusMultiplier(CurrentPlayer) + 1
				'TODO NZ: Show some info on the backglass or DMD
			End If
			
		End If
		
	End Sub

	Sub SetPowerupRamp(mode)
		WriteLog("Function=SetPowerupRamp mode=" & mode)
		'TODO NZ: maybe play something?
		PowerupRampMode = mode	
	End Sub
	
'---------MODE HELPERS-----------	
	Sub ActivateInvincibility(seconds)
		'TODO NZ: lights/dof, 
		'Set a timer to end it
		WriteLog("Function=ActivateInvincibility seconds=" & seconds)
		'order is important.  the invincibility flag needs to be set first to keep the saver toggles from making sounds
		Invincibility = True
		SetLeftOutlaneSaver(true)
		SetRightOutlaneSaver(true)
		L_InvincibleMode.State = 1
		'vpmtimer..... DeactivateInvincibility
		vpmTimer.AddTimer (seconds*1000), "DeactivateInvincibility() '"
	End Sub
	
	Sub DeactivateInvincibility 
		WriteLog("Function=DeactivateInvincibility")
		'Order is important.  If invincibility is set to off, then the saver toggles will make sounds
		L_InvincibleMode.State = 0

		SetLeftOutlaneSaver(false)
		SetRightOutlaneSaver(false)		
		Invincibility = False
		'TODO NZ: lights/dof, 
	End Sub
	
	Sub CheckMultiBallReady	
		If LeftLockballArmed AND RightLockballArmed Then
			L_MultiballReady.State = 2
		Else
			L_MultiballReady.State = 0
		End If
	End Sub
	
	Sub SetBallSaverMode(mode, delay)
		WriteLog("Function=SetBallSaverMode mode=" & mode & " delay=" & delay)
		bBallSaverActive = mode
		SetLeftOutlaneSaver(mode)
		SetRightOutlaneSaver(mode)			

		If mode Then
			WriteLog("Function=SetBallSaverMode Note='mode is true, setting timeout as passed'")
			'TODO NZ: dof/lights/etc'
			If delay > 0 Then
				vpmtimer.AddTimer delay, "SetBallSaverMode false, 0 '"
			End If
		Else 
			'TODO NZ: dof/lights/etc'
		End If
	End Sub
'---------BUMPER HELPERS-----------	
	Sub CheckBumperHitCount
		If BumperHitCount = BumperBonusCount Then
			'TODO NZ: Add PUP/Topper/Sounds/DOF
			BumperHitCount = 0
			AddBonus(50)
		End If	
	End Sub



'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  Queue for zero/low latency logging
'  http://www.4guysfromrolla.com/webtech/052200-1.shtml
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  
Class DynamicArray
  '************** Properties **************
  Private aData
  '****************************************

  '*********** Event Handlers *************
  Private Sub Class_Initialize()
    Redim aData(0)
  End Sub
  '****************************************

  '************ Property Get **************
  Public Property Get Data(iPos)
    'Make sure the end developer is not requesting an
    '"out of bounds" array element
    If iPos < LBound(aData) or iPos > UBound(aData) then
      Exit Property    'Invalid range
    End If

    Data = aData(iPos)
  End Property

  Public Property Get DataArray()
    DataArray = aData
  End Property
  '****************************************

  '************ Property Let **************
  Public Property Let Data(iPos, varValue)
    'Make sure iPos >= LBound(aData)
    If iPos < LBound(aData) Then Exit Property

    If iPos > UBound(aData) then
      'We need to resize the array
      Redim Preserve aData(iPos)
      aData(iPos) = varValue
    Else
      'We don't need to resize the array
      aData(iPos) = varValue
    End If
  End Property
  '****************************************


  '************** Methods *****************
  Public Function StartIndex()
     StartIndex = LBound(aData)
  End Function

  Public Function StopIndex()
     StopIndex = UBound(aData)
  End Function

  Public Sub Delete(iPos)
     'Make sure iPos is within acceptable ranges
     If iPos < LBound(aData) or iPos > UBound(aData) then
       Exit Sub    'Invalid range
     End If

     Dim iLoop
     For iLoop = iPos to UBound(aData) - 1
       aData(iLoop) = aData(iLoop + 1)
     Next

     Redim Preserve aData(UBound(aData) - 1)
  End Sub
  '****************************************
End Class	
	
Class WeakList
    '********* MEMBER VARIABLES **********
    Private dynArray
    '*************************************

    '********* EVENT HANDLERS ************
    Private Sub Class_Initialize()
      'Allocate the dynamic array instance
      Set dynArray = New DynamicArray
    End Sub

    Private Sub Class_Terminate()
      Set dynArray = Nothing       'Clean up!
    End Sub
    '*************************************

    '************ PROPERTIES *************
    Public Property Get Count()
      Count = dynArray.StopIndex() - dynArray.StartIndex()
    End Property
    '*************************************

    '************* METHODS ***************
    Public Sub AddHead(varItem)
    'Add an element to the start of the arrray
       'Start by moving all of the elements down on position
       Dim iLoop
       For iLoop = dynArray.StopIndex() to dynArray.StartIndex() STEP -1
         dynArray.Data(iLoop + 1) = dynArray.Data(iLoop)
       Next

       'Insert varItem at the head
       dynArray.Data(dynArray.StartIndex()) = varItem
    End Sub

    Public Function RemoveHead()
    'Remove and return the element from the start of the array
       'Don't do this if StopIndex() < StartIndex()
       If dynArray.StopIndex() > dynArray.StartIndex() then
         RemoveHead = dynArray.Data(dynArray.StartIndex())
         dynArray.Delete(dynArray.StartIndex())
       End If
    End Function


    Public Sub AddTail(varItem)
    'Add an element to the end of the array
       dynArray.Data(dynArray.StopIndex()) = varItem
    End Sub

    Public Function RemoveTail()
    'Remove and return the element from the end of the array
       'Don't do this if StopIndex() < StartIndex()
       If dynArray.StopIndex() > dynArray.StartIndex() then
         RemoveTail = dynArray.Data(dynArray.StopIndex() - 1)
         dynArray.Delete(dynArray.StopIndex() - 1)
       End If
    End Function


    Public Function PeekHead()
    'Return the element at the head of the array
       'Don't do this if StopIndex() < StartIndex()
       If dynArray.StopIndex() > dynArray.StartIndex() then
         PeekHead = dynArray.Data(dynArray.StartIndex())
       End If
    End Function

    Public Function PeekTail()
    'Return the element at the end of the array
       'Don't do this if StopIndex() < StartIndex()
       If dynArray.StopIndex() > dynArray.StartIndex() then
         PeekTail = dynArray.Data(dynArray.StopIndex() - 1)
       End If
    End Function
    '*************************************
  End Class


Class Queue

  '********* MEMBER VARIABLES **********
  Private wlList
  '*************************************

  '********* EVENT HANDLERS ************
  Private Sub Class_Initialize()
    'Allocate the weak list instance
    Set wlList = New WeakList
  End Sub

  Private Sub Class_Terminate()
    Set wlList = Nothing       'Clean up!
  End Sub
  '*************************************
       
  '************ PROPERTIES *************
  Public Property Get Count()
    Count = wlList.Count
  End Property
  '*************************************

  '************* METHODS ***************
  Public Function Enqueue(varItem)
    wlList.AddHead(varItem)
  End Function

  Public Function Dequeue()
    Dequeue = wlList.RemoveTail()
  End Function

  Public Function Peek()
     Peek = wlList.PeekTail()
  End Function
  '*************************************
End Class

Sub Table1_Exit()
	LogFile.Close()
End Sub







''''''''''''''''''''''OLD CODE''''''''''''''''''''
'	Sub DT_RightLockball_Hit
'		WriteLog("Function=DT_RightLockball")
'		AddScore(100)
'		If NOT bMultiBallMode Then
'			WriteLog("Function=DT_RightLockball Note='It's not multiball - scheduling popup in 15 seconds")
'			vpmtimer.addtimer 15000, "DT_RightLockball.IsDropped = 0"
'		End If
'		'ObtainPlayfieldObjective(LowerPlayfieldObjective) 
'	End Sub




'Sub TR_RightInlane_Hit	
	'keeping just in case
'		WriteLog("Function=TR_LeftInlane_Hit")
'		PlaySoundAt "fx_sensor", ActiveBall
'		If bMultiBallMode = False Then
'			PlaySound "lane"
'			DOF 144, DOFPulse
'			DOF 313, DOFPulse   'DOF MX - Left Outer Lane
'		End If
'		
'		If Tilted Then Exit Sub
'		
'		LaneBonus = LaneBonus + 1
'		'll1.State = 1
'		'll8.State = 1
'		AddScore 50050
'		' Do some sound or light effect
'		'LastSwitchHit = "lane1"





	'Sub GA_PowerupRamp_Hit	
	'keeping just in case
	'		WriteLog("Function=GA_PowerupRamp_Hit")
'		If NOT Tilted AND PowerupRampMode Then
'			StreamOrbitCount = StreamOrbitCount + 1
'			WriteLog("Function=GA_PowerupRamp_Hit StreamOrbitCount=" & StreamOrbitCount)			
'			If StreamOrbitCount >= 3 Then
'				ObtainPlayfieldObjective(OrbitPlayfieldObjective) 
'
'				StreamOrbitCount = 0
'				If NOT JackpotActive Then
'					WriteLog("Function=GA_PowerupRamp_Hit Note='Jackpot active from powerup ramp'")
'					JackpotActive = True
'					'TODO NZ: dof/sound/etc
'				End If
'				ActivateInvincibility(10)
'			
'			End If
'		
'		Else 
'			WriteLog("Function=GA_PowerupRamp_Hit Note='powerup ramp not active'")
'		End If
'	
	'End Sub

	
	
	
	
	
	
	'keeping these just in case
'	Sub B_Left_Hit
'		WriteLog("Function=B_Left_Hit")
'		LightEffect 5
'		If NOT Tilted Then
'			PlaySoundAt SoundFXDOF("fx_bumper", 107, DOFPulse, DOFContactors), ActiveBall
'			DOF 110, DOFPulse
'			DOF 302, DOFPulse   'DOF MX - Bumper 1
'			AddScore(1)
'			BumperHitCount = BumperHitCount + 1
'			CheckBumperHitCount
'		End If
'	End Sub
'
'	Sub B_Right_Hit
'		WriteLog("Function=B_Right_Hit")
'		LightEffect 5
'		If NOT Tilted Then
'			PlaySoundAt SoundFXDOF("fx_bumper", 109, DOFPulse, DOFContactors), ActiveBall
'			DOF 111, DOFPulse
'			DOF 303, DOFPulse   'DOF MX - Bumper 2
'			AddScore(1)
'			BumperHitCount = BumperHitCount + 1
'			CheckBumperHitCount
'		End If
'	End Sub
'
'	Sub B_Lower_Hit
'		WriteLog("Function=B_Lower_Hit")
'		LightEffect 5
'		If NOT Tilted Then
'			PlaySoundAt SoundFXDOF("fx_bumper", 108, DOFPulse, DOFContactors), ActiveBall
'			DOF 112, DOFPulse
'			DOF 304, DOFPulse   'DOF MX - Bumper 3
'			AddScore(1)
'			BumperHitCount = BumperHitCount + 1
'			CheckBumperHitCount
'		End If
'	End Sub
'





'keeping just in case
	'	Sub TR_TopLaneLeft_Hit
'		WriteLog("Function=TR_TopLaneLeft_Hit")
'		'TODO NZ: needs points and check for all of them highlighted to activate multiplier
'		AddScore(5)
'		ToggleTopLane("S")
'	End Sub
'
'	Sub TR_TopLaneCenter_Hit
'		WriteLog("Function=TR_TopLaneCenter_Hit")
'		AddScore(5)
'		ToggleTopLane("P")
'	End Sub
'
'	Sub TR_TopLaneRight_Hit
'		WriteLog("Function=TR_TopLaneRight_Hit")
'		AddScore(5)
'		ToggleTopLane("L")
'	End Sub





'	Sub KI_LeftOutlaneSaver_Hit
'		WriteLog("Function=KI_LeftOutlaneSaver_Hit")
'		KI_LeftOutlaneSaver.Kick 0, 50
'		'TODO NZ: Animate P_LeftOutlaneSaver
'	End Sub





	
'	Sub TR_PlungerLane_Hit
'		WriteLog("Function=TR_PlungerLane_Hit Note='Ball has left the plunger lane'")
'		vpmTimer.AddTimer 1000, "TogglePowerupRamp true '"
'	End Sub

	
	
'	Sub TR_LeftOutlane_Hit
'		WriteLog("Function=TR_LeftOutlaneTrigger_Hit")	
'		'TODO NZ: assign points and disable saver maybe
'		If NOT Invincibility Then
'			If LeftOutlaneSaverMode Then
'				'play some music "you got saved!"
'				'vpmtimer delay 1 second ToggleLeftOutlaneSaver(false)
'			Else
'				'assign points, going to drain
'			End If
'			
'		Else 
'			'play a sound for invincible kickback
'		End If
'	End Sub

		
'	Sub TR_RightOutlane_Hit
'		WriteLog("Function=TR_RightOutlane_Hit")
'		If NOT Invincibility Then
'			If RightOutlaneSaverMode Then
'				'disable saver after short timeout ToggleRightOutlaneSaver(false)
'			Else
'				'assign points going to drain
'			End If
'			
'		Else
'			'play a sound for invincible saved
'		End If

		'TODO NZ: assign points and disable saver maybe	
'	End Sub




'	Sub KI_LeftLockball_Hit
'		WriteLog("Function=KI_LeftLockball_Hit")
'		If LeftLockballMode Then
'			WriteLog("Function=KI_LeftLockball_Hit Note='lockball mode is enabled'")
'			'TODO NZ: dof/sound/etc
'		Else
'			WriteLog("Function=KI_LeftLockball_Hit Note='lockball mode is disabled'")
'			AddScore(100) 'TODO NZ: Fix this
'			KI_LeftLockball.Kick 180, 40
'			'TODO NZ dof
'		End If
'	
'	End Sub





	'Sub KI_LeftLockball_Hit:ProcessHit("KI_LeftLockball_Hit"):End Sub
	'Sub DT_UpperLeft_Hit:ProcessHit("DT_UpperLeft_Hit"):End Sub
	'Sub DT_UpperCenter_Hit:ProcessHit("DT_UpperCenter_Hit"):End Sub
	'Sub DT_UpperRight_Hit:ProcessHit("DT_UpperRight_Hit"):End Sub
	'Sub DT_LowerLeft_Hit:ProcessHit("DR_LowerLeft_Hit"):End Sub
	'Sub DT_LowerCenter_Hit:ProcessHit("DR_LowerCenter_Hit"):End Sub
	'Sub DT_LowerRight_Hit:ProcessHit("DR_LowerRight_Hit"):End Sub
	'Sub TA_ObjectiveA_Hit:ProcessHit("TA_ObjectiveA_Hit"):End Sub
	'Sub TA_ObjectiveB_Hit:ProcessHit("TA_ObjectiveB_Hit"):End Sub
	'Sub TA_ObjectiveC_Hit:ProcessHit("TA_ObjectiveC_Hit"):End Sub
	'Sub TA_ObjectiveD_Hit:ProcessHit("TA_ObjectiveD_Hit"):End Sub
	'Sub TA_ObjectiveE_Hit:ProcessHit("TA_ObjectiveE_Hit"):End Sub
	'Sub TR_PowerupRamp_Hit:ProcessHit("TR_PowerupRamp_Hit"):End Sub
	'Sub DT_RightLockball_Hit:ProcessHit("DT_RightLockball_Hit"):End Sub
	'Sub TR_PlungerLane_Hit:ProcessHit("TR_PlungerLane_Hit"):End Sub
	'Sub TR_LeftOutlane_Hit:ProcessHit("TR_LeftOutlane_Hit"):End Sub
	'Sub TR_RightOutlane_Hit:ProcessHit("TR_RightOutlane_Hit"):End Sub
	'Sub KI_LeftOutlaneSaver_Hit:ProcessHit("KI_LeftOutlaneSaver_Hit"):End Sub
 	'Sub TR_TopLaneLeft_Hit:ProcessHit("TR_TopLaneLeft_Hit"):End Sub
	'Sub TR_TopLaneLeft_Hit:ProcessHit("TR_TopLaneLeft_Hit"):End Sub
	'Sub TR_TopLaneLeft_Hit:ProcessHit("TR_TopLaneLeft_Hit"):End Sub
	'Sub B_Left_Hit:ProcessHit("B_Left_Hit"):End Sub
	'Sub B_Right_Hit:ProcessHit("B_Right_Hit"):End Sub
	'Sub B_Lower_Hit:ProcessHit("B_Lower_Hit"):End Sub
	'Sub TR_LeftInlane_Hit:ProcessHit("TR_LeftInlane_Hit"):End Sub
	'Sub TR_RightInlane_Hit:ProcessHit("TR_RightInlane_Hit"):End Sub
	'Sub GA_PowerupRamp_Hit:ProcessHit("GA_PowerupRamp_Hit"):End Sub
	
